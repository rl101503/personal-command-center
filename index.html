<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personal Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Inter Tight font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter Tight", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #000000;
      color: #f9fafb;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .header-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    h1 {
      font-size: 1.8rem;
      color: #ffc532;
    }

    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      color: #e5eef7;
      margin-top: 0.25rem;
    }

    .header-right {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .logo {
      max-height: 42px;
      width: auto;
      object-fit: contain;
    }

    .auth-tile {
      width: 115px;
      height: 118px;
      background: #103454;
      border-radius: 0.9rem;
      padding: 0.4rem 0.45rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.6);
      border: 1px solid #1797d7;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 0.3rem;
    }

    .auth-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #ffc532;
    }

    .auth-status {
      font-size: 0.7rem;
      opacity: 0.9;
      color: #e5eef7;
      margin-top: 0.2rem;
    }

    .card {
      background: #103454;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 14px 30px rgba(0,0,0,0.6);
      border: 1px solid #1797d7;
      margin-bottom: 1.2rem;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 0.4rem;
      color: #ffc532;
    }

    .card p {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 0.8rem;
      color: #e5eef7;
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
      color: #e5eef7;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #1797d7;
      background: #000000;
      color: #f9fafb;
      margin-bottom: 0.7rem;
      font-size: 0.85rem;
    }

    textarea {
      resize: vertical;
      min-height: 2.5rem;
      max-height: 6rem;
    }

    input::placeholder,
    textarea::placeholder {
      color: #64748b;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #ffc532;
      color: #000000;
      margin-top: 0.3rem;
      transition: filter 0.1s ease, transform 0.1s ease;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid #1797d7;
      color: #e5e7eb;
    }

    .btn-secondary:hover {
      border-color: #ffc532;
      color: #ffc532;
    }

    .btn-small {
      padding: 0.35rem 0.9rem;
      font-size: 0.75rem;
      margin-top: 0.15rem;
    }

    #signInBtn {
      width: auto;
      min-width: 84px;
      font-size: 0.68rem;
      padding: 0.35rem 0.6rem;
      clip-path: polygon(25% 6%, 75% 6%, 96% 50%, 75% 94%, 25% 94%, 4% 50%);
      background: linear-gradient(135deg, #ffc532, #f59e0b);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    #signOutBtn {
      width: 100%;
      font-size: 0.7rem;
      padding: 0.3rem 0.4rem;
    }

    .results {
      margin-top: 1.2rem;
      padding-top: 1rem;
      border-top: 1px solid #1797d7;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .result-pill {
      border-radius: 0.75rem;
      padding: 0.6rem 0.8rem;
      background: #020617;
      border: 1px solid rgba(23,151,215,0.6);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .result-pill.highlight {
      border-color: #ffc532;
      background: #111827;
    }

    .result-label {
      font-size: 0.75rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .result-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .tiny {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 0.7rem;
      color: #e5eef7;
    }

    /* History / tables (more compact) */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.25rem 0.35rem;
      border-bottom: 1px solid rgba(23,151,215,0.6);
      text-align: left;
      white-space: nowrap;
      vertical-align: top;
    }

    th {
      background: #007f91;
      position: sticky;
      top: 0;
      z-index: 1;
      color: #f9fafb;
    }

    td:nth-last-child(2),
    th:nth-last-child(2),
    td:last-child,
    th:last-child {
      text-align: right;
    }

    .history-wrapper {
      max-height: 260px;
      overflow-y: auto;
      overflow-x: auto;
      border-radius: 0.5rem;
      border: 1px solid #1797d7;
      margin-top: 0.6rem;
      background: #020617;
    }

    /* Larger, tighter budget table */
    .budget-wrapper {
      max-height: 420px;
    }

    .budget-wrapper table th,
    .budget-wrapper table td {
      padding: 0.2rem 0.3rem;
      white-space: nowrap;
      font-size: 0.75rem;
    }

    .budget-input {
      font-size: 0.72rem;
      padding: 0.18rem 0.25rem;
      margin-bottom: 0.3rem;
    }

    /* Zebra stripes for history */
    #historyBody tr:nth-child(odd) {
      background-color: #f8f8f8;
      color: #000000;
    }

    #historyBody tr:nth-child(even) {
      background-color: #82889b;
      color: #f8f8f8;
    }

    #historyBody tr td button.delete-btn {
      color: #ffc532;
      border-color: #e24301;
      background: transparent;
    }

    .history-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .history-header-row h2 {
      margin-bottom: 0.1rem;
    }

    .totals-row {
      font-weight: 700;
      background: #007f91;
      border-top: 2px solid #ffc532;
      color: #f9fafb;
    }

    .totals-note {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .totals-summary {
      margin-top: 0.4rem;
    }

    .totals-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .totals-table td {
      padding: 0.25rem 0.35rem;
    }

    .hidden {
      display: none;
    }

    .delete-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid #e24301;
      padding: 0.1rem 0.45rem;
      font-size: 0.7rem;
      color: #ffc532;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: rgba(226,67,1,0.2);
      border-color: #e24301;
      color: #ffe4d5;
    }

    /* KPI Dashboard strip */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin: 0.6rem 0 0.4rem 0;
    }

    .kpi-card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid rgba(23,151,215,0.6);
    }

    .kpi-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-bottom: 0.15rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .kpi-value {
      font-size: 1rem;
      font-weight: 600;
    }

    /* Comp tracker */
    .comp-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-top: 0.75rem;
      align-items: flex-start;
    }

    .comp-settings {
      flex: 1 1 350px;
      min-width: 0;
    }

    .comp-chart-container {
      flex: 0 0 260px;
      max-width: 260px;
    }

    .comp-chart-container canvas {
      width: 100%;
      height: auto;
    }

    #compLineChart {
      margin-top: 0.75rem;
      max-height: 220px;
    }

    .comp-table-wrapper {
      margin-top: 0.8rem;
    }

    .comp-table input[type="text"] {
      padding: 0.25rem 0.35rem;
      margin-bottom: 0;
      font-size: 0.78rem;
    }

    .comp-table th,
    .comp-table td {
      white-space: nowrap;
      padding: 0.2rem 0.3rem;
      font-size: 0.78rem;
    }

    .readonly-input {
      background: #0a2235 !important;
      color: #cbd5e1;
      cursor: not-allowed;
      opacity: 0.9;
    }

    #compSummary {
      margin-top: 0.35rem;
    }

    .comp-chart-labels {
      margin-top: 0.6rem;
      font-size: 0.8rem;
    }

    .comp-chart-line {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .comp-chart-label-title {
      font-weight: 600;
      font-size: 0.78rem;
    }

    .comp-chart-label-value {
      font-weight: 600;
      font-size: 0.78rem;
    }

    .comp-chart-earned {
      color: #22c55e;
    }

    .comp-chart-remaining {
      color: #ef4444;
    }

    .comp-tables-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.8rem;
    }

    .comp-table-wrapper.history-wrapper {
      max-height: 230px;
    }

    .comp-table-wrapper {
      flex: 1 1 0;
    }

    /* Tabs */
    .tab-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #1797d7;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      position: sticky;
      top: 0;
      background: #000000;
      z-index: 5;
      padding-top: 0.2rem;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .tab-button {
      background: transparent;
      border-radius: 999px;
      padding: 0.4rem 1rem;
      border: 1px solid transparent;
      color: #e5eef7;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .tab-button.active {
      background: #007f91;
      border-color: #ffc532;
      color: #f9fafb;
    }

    .save-dashboard-btn {
      margin-left: auto;
      padding-inline: 1.1rem;
      white-space: nowrap;
    }

    .budget-wrapper table th {
      text-align: center;
    }

    .budget-wrapper table td {
      text-align: left;
    }

    .progress-track {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(23,151,215,0.6);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      width: 0%;
      transition: width 0.2s ease;
    }

    #debtGoalProgress {
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      box-shadow: 0 0 12px rgba(239,68,68,0.45);
    }

    /* Personal finances layout helpers */
    .pf-income-summary {
      margin-bottom: 0.75rem;
    }

    .pf-income-summary .results-grid {
      margin-bottom: 0;
    }

    .pf-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .pf-col-half {
      flex: 1 1 0;
      min-width: 0;
    }

    .card-debt {
      background: rgba(239,68,68,0.15);
      border-color: #ef4444;
    }

    .card-invest {
      background: rgba(34,197,94,0.15);
      border-color: #22c55e;
    }

    .pill-input {
      margin-bottom: 0.2rem;
      padding: 0.35rem 0.6rem;
      font-size: 0.85rem;
    }

    .sort-btn {
      background: transparent;
      border: 1px solid #1797d7;
      color: #e5eef7;
      font-size: 0.65rem;
      padding: 0.1rem 0.35rem;
      border-radius: 999px;
      margin-left: 0.25rem;
      margin-top: 0;
    }

    .sort-btn:hover {
      border-color: #ffc532;
      color: #ffc532;
      background: rgba(15,23,42,0.4);
    }

    .budget-total-row {
      position: sticky;
      bottom: 0;
      background: #0b2234;
      color: #ffc532;
      font-weight: 700;
      border-top: 2px solid #ffc532;
    }

    .budget-total-row td {
      padding: 0.35rem 0.45rem;
    }

    .goals-sort-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.6rem;
    }

    .goals-sort-actions {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .section-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .reading-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.8rem;
    }

    .reading-pill {
      background: #020617;
      border: 1px solid rgba(23,151,215,0.6);
      border-radius: 999px;
      padding: 0.5rem 0.85rem;
      font-weight: 600;
      color: #e5eef7;
      text-align: left;
      min-width: 160px;
    }

    .store-header {
      width: 100%;
      padding: 0.2rem 0.3rem;
      margin-bottom: 0;
      font-size: 0.75rem;
      background: #000000;
      color: #f9fafb;
      border-radius: 0.3rem;
      border: 1px solid #1797d7;
    }

    /* Single Deal layout */
    .singledeal-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin-top: 0.6rem;
      align-items: flex-start;
    }

    .singledeal-inputs {
      flex: 1 1 300px;
      min-width: 0;
    }

    .singledeal-results {
      flex: 0 0 280px;
      max-width: 280px;
    }

    .singledeal-inputs-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.6rem;
      margin-bottom: 0.5rem;
    }

    .singledeal-notes {
      margin-top: 0.3rem;
    }

    @media (max-width: 800px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-items: center;
      }
      .logo {
        max-height: 40px;
      }
      h1 {
        font-size: 1.5rem;
      }
      .card {
        padding: 1.2rem;
      }
      .singledeal-layout {
        flex-direction: column;
      }
      .singledeal-results {
        max-width: 100%;
      }
    }

    @media (max-width: 600px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 0.2rem 0.3rem;
      }
      .comp-chart-container {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER WITH LOGO + AUTH TILE -->
    <div class="header-row">
      <div>
        <h1>Personal Command Center</h1>
        <p class="subtitle">Commission tracker plus a living monthly budget in one place.</p>
      </div>
      <div class="header-right">
        <img
          src="https://companieslogo.com/img/orig/PINC.D-30c75340.png?t=1720244493"
          alt="Premier Inc. logo"
          class="logo"
        />
        <div class="auth-tile">
          <div class="auth-title">Account</div>
          <button type="button" id="signInBtn">Sign in with Google</button>
          <button type="button" id="signOutBtn" class="btn-secondary btn-small hidden">Sign out</button>
          <div id="authStatus" class="auth-status">Not signed in.</div>
        </div>
      </div>
    </div>

    <!-- MAIN APP CONTENT (shown only when signed in) -->
    <div id="appContent" class="hidden">
      <!-- TAB NAV -->
      <div class="tab-nav">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="commission">Commission Tracker</button>
          <button class="tab-button" data-tab="personal">Personal Finances</button>
          <button class="tab-button" data-tab="goals">Goals</button>
        </div>
        <button type="button" class="save-dashboard-btn" onclick="onSaveDashboardClick()">Save Dashboard</button>
      </div>

      <!-- COMMISSION TAB -->
      <div id="commissionTab">
        <!-- SINGLE DEAL CALCULATOR -->
        <div class="card">
          <h2>Single Deal Calculator</h2>
          <p>
            Enter the deal amount (ARR or TCV), pick the deal type and term, and we’ll calculate
            your total commission, post-tax amount, and first-month payout. Each calculation will
            be saved to your history in the cloud.
          </p>

          <div class="singledeal-layout">
            <!-- Left: inputs -->
            <div class="singledeal-inputs">
              <div class="singledeal-inputs-row">
                <div>
                  <label for="dealAmount">Deal Amount (USD)</label>
                  <input
                    id="dealAmount"
                    type="text"
                    placeholder="e.g., 250,000"
                  />
                </div>
                <div>
                  <label for="dealType">Deal Type</label>
                  <select id="dealType">
                    <option value="New">New business</option>
                    <option value="RenewalOut">Renewal with any-time out clause</option>
                    <option value="Renewal&lt;100%">Renewal &lt;100%</option>
                    <option value="Renewal=100%">Renewal =100%</option>
                    <option value="Renewal&gt;100%">Renewal &gt;100%</option>
                  </select>
                </div>
                <div id="termRow">
                  <label for="dealTerm">Term</label>
                  <select id="dealTerm"></select>
                </div>
              </div>

              <div class="singledeal-notes">
                <label for="dealNotes">Deal Notes (optional)</label>
                <textarea
                  id="dealNotes"
                  placeholder="e.g., Client signed at steering committee; includes add-on analytics module."
                ></textarea>
              </div>

              <button type="button" id="calcBtn">Calculate Commission</button>

              <p class="tiny">
                Assumes 34% tax (you keep 66%). For <strong>new business</strong>, assumes 50% of the commission is paid in month 1 (≈33% of total commission pre-tax). For <strong>renewals</strong>, 100% of commission is paid in the first month.
              </p>
            </div>

            <!-- Right: results pills -->
            <div class="singledeal-results">
              <div class="results">
                <div class="results-grid">
                  <div class="result-pill highlight">
                    <div class="result-label">First-month commission (post-tax)</div>
                    <div class="result-value" id="firstMonthDisplay">–</div>
                  </div>
                  <div class="result-pill">
                    <div class="result-label">Total commission (post-tax)</div>
                    <div class="result-value" id="totalCommissionPostTaxDisplay">–</div>
                  </div>
                  <div class="result-pill">
                    <div class="result-label">Total commission (pre-tax)</div>
                    <div class="result-value" id="totalCommissionDisplay">–</div>
                  </div>
                  <div class="result-pill">
                    <div class="result-label">Rate used</div>
                    <div class="result-value" id="rateDisplay">–</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- VARIABLE COMP TRACKER -->
        <div class="card">
          <div class="history-header-row">
            <div>
              <h2>Variable Compensation Tracker</h2>
              <p>
                Track progress toward your annual variable target. Fiscal year runs July–June.
                Values are saved to your account and are available on any device when you sign in with Google.
              </p>
            </div>
            <button type="button" id="compEditBtn" class="btn-secondary btn-small">Edit amounts</button>
          </div>

          <div class="comp-layout">
            <div class="comp-settings">
              <label for="annualTarget">Annual variable target (USD)</label>
              <input id="annualTarget" type="text" />

              <div class="results-grid" style="margin-top:0.4rem;">
                <div class="result-pill">
                  <div class="result-label">Average monthly take home – post tax</div>
                  <div class="result-value" id="compAvgTakeHome">–</div>
                </div>
              </div>

              <p class="tiny" id="compSummary" style="margin-top:0.4rem;">
                Loading compensation tracker…
              </p>

              <canvas id="compLineChart"></canvas>
            </div>

            <div class="comp-chart-container">
              <canvas id="compPieChart"></canvas>
              <div class="comp-chart-labels">
                <div class="comp-chart-line">
                  <span class="comp-chart-label-title comp-chart-earned">Amount earned</span>
                  <span id="compEarnedLabel" class="comp-chart-label-value comp-chart-earned">$0</span>
                </div>
                <div class="comp-chart-line">
                  <span class="comp-chart-label-title comp-chart-remaining">Remaining amount to be earned</span>
                  <span id="compRemainingLabel" class="comp-chart-label-value comp-chart-remaining">$0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="comp-tables-row">
            <div class="comp-table-wrapper history-wrapper">
              <table class="comp-table">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Variable compensation</th>
                    <th>Take home (66%)</th>
                  </tr>
                </thead>
                <tbody id="compTableBody1">
                  <!-- populated by JS -->
                </tbody>
              </table>
            </div>
            <div class="comp-table-wrapper history-wrapper">
              <table class="comp-table">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Variable compensation</th>
                    <th>Take home (66%)</th>
                  </tr>
                </thead>
                <tbody id="compTableBody2">
                  <!-- populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="card">
          <div class="history-header-row">
            <div>
              <h2>History</h2>
              <p class="tiny" style="margin-top:0;">
                Stored in Firestore for your account. Sign in on any device with the same Google account
                to see the same history.
              </p>
            </div>
            <button type="button" id="clearHistoryBtn" class="btn-secondary btn-small">Clear History</button>
          </div>

          <!-- Mini dashboard strip -->
          <div class="kpi-row">
            <div class="kpi-card">
              <div class="kpi-label">This month (post-tax)</div>
              <div class="kpi-value" id="kpiThisMonth">$0</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Fiscal YTD (post-tax)</div>
              <div class="kpi-value" id="kpiFiscalYtd">$0</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Largest deal amount</div>
              <div class="kpi-value" id="kpiLargestDeal">$0</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Fiscal YTD first-month</div>
              <div class="kpi-value" id="kpiFiscalYtdFirst">$0</div>
            </div>
          </div>

          <div class="history-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Deal Type</th>
                  <th>Term</th>
                  <th>Amount</th>
                  <th>Total Post-tax</th>
                  <th>First Month</th>
                  <th>Notes</th>
                  <th></th> <!-- delete column -->
                </tr>
              </thead>
              <tbody id="historyBody">
                <!-- rows added by JS -->
              </tbody>
            </table>
          </div>

          <!-- Totals always visible -->
          <div class="totals-summary">
            <table class="totals-table">
              <tbody>
                <tr class="totals-row">
                  <td>Totals</td>
                  <td colspan="2" class="totals-note">
                    Amount = deal size; Total Post-tax = total commission after tax; First Month = post-tax commission paid in month 1.
                  </td>
                  <td id="totalsAmount">$0</td>
                  <td id="totalsPostTax">$0</td>
                  <td id="totalsFirstMonth">$0</td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- end commissionTab -->

      <!-- PERSONAL FINANCES TAB -->
      <div id="personalTab" class="hidden">
        <!-- Income summary pills at top -->
        <div class="pf-income-summary">
          <div class="results-grid">
            <div class="result-pill">
              <div class="result-label">Current monthly take home</div>
              <div class="result-value" id="pfMonthlyNet">–</div>
            </div>
            <div class="result-pill">
              <div class="result-label">Average monthly take home – post tax</div>
              <div class="result-value" id="pfAvgMonthlyTakeHome">–</div>
            </div>
            <div class="result-pill">
              <div class="result-label">Total Monthly Take home</div>
              <div class="result-value" id="pfTotalMonthly">–</div>
            </div>
            <div class="result-pill">
              <div class="result-label">401k tracker (USD)</div>
              <input
                id="pf401kTracker"
                type="text"
                class="pill-input"
                placeholder="$0"
              />
              <div class="result-label" id="pf401kTargetText">
                Target: $23,500 · <span id="pf401kPercent">0%</span> of target
              </div>
            </div>
          </div>
        </div>

        <!-- Income & Monthly Budget -->
        <div class="card">
          <div class="history-header-row">
            <div>
              <h2>Income & Monthly Budget</h2>
              <p>
                Editable monthly budget based on your spreadsheet. Numbers here are your working “source of truth”
                for fixed + variable expenses.
              </p>
            </div>
            <button type="button" id="budgetEditBtn" class="btn-secondary btn-small">Edit budget</button>
          </div>

          <div class="history-wrapper budget-wrapper">
            <table>
              <thead>
                <tr>
                  <th>
                    Category
                    <button type="button" id="budgetSortCategory" class="sort-btn">Sort A/Z</button>
                  </th>
                  <th>
                    Amount (USD)
                    <button type="button" id="budgetSortAmount" class="sort-btn">Sort ↑↓</button>
                  </th>
                  <th>Withdraw date</th>
                  <th>Fixed / Variable</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="budgetTableBody">
                <!-- populated by JS -->
              </tbody>
              <tfoot>
                <tr class="budget-total-row">
                  <td>Sum of all monthly expenses</td>
                  <td id="budgetTotalFrozen">$0</td>
                  <td colspan="3"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="totals-summary">
            <table class="totals-table">
              <tbody>
                <tr class="totals-row">
                  <td>Total</td>
                  <td id="budgetTotal">$0</td>
                  <td colspan="3"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="totals-summary">
            <div class="results-grid">
              <div class="result-pill">
                <div class="result-label">Total monthly expenses as % of total monthly take-home</div>
                <div class="result-value" id="budgetPctOfIncome">–</div>
              </div>
              <div class="result-pill">
                <div class="result-label">Monthly surplus</div>
                <div class="result-value" id="budgetMonthlySurplus">–</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Groceries + Upcoming Purchases row -->
        <div class="pf-row">
          <!-- Groceries / Amazon / Retail -->
          <div class="pf-col-half">
            <div class="card">
              <div class="history-header-row">
                <div>
                  <h2>Groceries & Retail Averages</h2>
                  <p>
                    Store-level monthly averages for Amazon, Teeter, Walmart, Publix, and Target.
                    Period headers are editable so you can label any time ranges (e.g., Feb24–Jan25).
                  </p>
                </div>
                <button type="button" id="storeEditBtn" class="btn-secondary btn-small">Edit</button>
              </div>

              <div class="history-wrapper">
                <table>
                  <thead id="storeTableHead"></thead>
                  <tbody id="storeTableBody">
                    <!-- populated by JS -->
                  </tbody>
                </table>
              </div>
              <button type="button" id="storeAddRowBtn" class="btn-secondary btn-small hidden">+ Add Row</button>
              <div class="totals-summary">
                <table class="totals-table">
                  <tbody>
                    <tr class="totals-row">
                      <td>Total (all stores)</td>
                      <td id="storeTotalCol1">$0</td>
                      <td id="storeTotalCol2">$0</td>
                      <td id="storeTotalCol3">$0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Upcoming Purchases -->
          <div class="pf-col-half">
            <div class="card">
              <div class="history-header-row">
                <div>
                  <h2>Upcoming Purchases</h2>
                  <p>
                    Free-form list of upcoming purchases. Edit categories and amounts as needed.
                  </p>
                </div>
                <button type="button" id="upcomingEditBtn" class="btn-secondary btn-small">Edit</button>
              </div>

              <div class="history-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Amount (USD)</th>
                    </tr>
                  </thead>
                  <tbody id="upcomingTableBody">
                    <!-- populated by JS -->
                  </tbody>
                </table>
              </div>
              <button type="button" id="upcomingAddRowBtn" class="btn-secondary btn-small hidden">+ Add Row</button>
              <div class="totals-summary">
                <table class="totals-table">
                  <tbody>
                    <tr class="totals-row">
                      <td>Total</td>
                      <td id="upcomingTotal">$0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Debt + Investments row -->
        <div class="pf-row">
          <!-- Debt Balances -->
          <div class="pf-col-half">
            <div class="card card-debt">
              <div class="history-header-row">
                <div>
                  <h2>Debt Balances</h2>
                  <p>
                    Snapshot of major debts. Balances are editable; total updates automatically.
                  </p>
                </div>
                <button type="button" id="debtEditBtn" class="btn-secondary btn-small">Edit</button>
              </div>

              <div class="history-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Debt</th>
                      <th>Balance (USD)</th>
                    </tr>
                  </thead>
                  <tbody id="debtTableBody">
                    <!-- populated by JS -->
                  </tbody>
                </table>
              </div>
              <button type="button" id="debtAddRowBtn" class="btn-secondary btn-small hidden">+ Add Row</button>
              <div class="totals-summary">
                <table class="totals-table">
                  <tbody>
                    <tr class="totals-row">
                      <td>Total</td>
                      <td id="debtTotal">$0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Investments -->
          <div class="pf-col-half">
            <div class="card card-invest">
              <div class="history-header-row">
                <div>
                  <h2>Assets</h2>
                  <p>
                    High-level view of assets and account balances. Edit balances as needed; totals will update.
                  </p>
                </div>
                <button type="button" id="investEditBtn" class="btn-secondary btn-small">Edit</button>
              </div>

              <div class="history-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Account</th>
                      <th>Balance (USD)</th>
                    </tr>
                  </thead>
                  <tbody id="investTableBody">
                    <!-- populated by JS -->
                  </tbody>
                </table>
              </div>
              <button type="button" id="investAddRowBtn" class="btn-secondary btn-small hidden">+ Add Row</button>
              <div class="totals-summary">
                <table class="totals-table">
                  <tbody>
                    <tr class="totals-row">
                      <td>Total</td>
                      <td id="investTotal">$0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- end personalTab -->

      <!-- GOALS TAB -->
      <div id="goalsTab" class="hidden">
        <div class="results-grid" style="margin-bottom:1rem;">
          <div class="result-pill">
            <div class="result-label">Reading Goal – 55 Books</div>
            <div class="result-value" id="readingGoalSummary">Completed: 0 / 55</div>
            <div class="progress-track"><div class="progress-bar" id="readingGoalProgress"></div></div>
          </div>
          <div class="result-pill">
            <div class="result-label">Debt Payoff</div>
            <div class="result-value" id="debtGoalSummary">Total debt: $0</div>
            <div class="progress-track"><div class="progress-bar" id="debtGoalProgress"></div></div>
          </div>
        </div>

        <div class="card">
          <div class="history-header-row">
            <div>
              <h2>Reading Goal – 55 Books</h2>
              <p>Track completed books and plan your next reads. Toggle edit mode to update lists.</p>
              <p class="tiny" id="readingGoalStats">Target: 55 · Completed: 0 · Remaining: 55</p>
              <div class="progress-track"><div class="progress-bar" id="readingCardProgress"></div></div>
            </div>
            <button type="button" id="readingEditBtn" class="btn-secondary btn-small">Edit Reading List</button>
          </div>

          <div class="reading-pill-row">
            <div class="reading-pill">Books Completed</div>
            <div class="reading-pill">Books To Read</div>
          </div>

          <div class="section-controls">
            <h3 style="margin:0;">Books Completed</h3>
            <button type="button" id="goalsSortReading" class="sort-btn">Sort reading A/Z</button>
          </div>
          <div class="history-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Author</th>
                  <th>Format (Text/Audio)</th>
                  <th>Rating</th>
                  <th>Month Finished</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="booksCompletedBody"></tbody>
            </table>
          </div>
          <button type="button" id="booksCompletedAddBtn" class="btn-secondary btn-small hidden">+ Add Row</button>

          <div class="section-controls" style="margin-top:1rem;">
            <h3 style="margin:0;">Books To Read</h3>
          </div>
          <div class="history-wrapper" style="margin-top:0.4rem;">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Author</th>
                </tr>
              </thead>
              <tbody id="booksToReadBody"></tbody>
            </table>
          </div>
          <button type="button" id="booksToReadAddBtn" class="btn-secondary btn-small hidden">+ Add Row</button>
        </div>

        <div class="card">
          <div class="history-header-row">
            <div>
              <h2>Debt Payoff Goal</h2>
              <p>Live snapshot of current debts pulled from the Debt Balances section.</p>
            </div>
            <button type="button" id="debtGoalEditBtn" class="btn-secondary btn-small">Edit</button>
          </div>

          <div class="section-controls">
            <h3 style="margin:0;">Debt Snapshot</h3>
            <button type="button" id="goalsSortDebt" class="sort-btn">Sort debt high/low</button>
          </div>

          <div class="history-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Debt</th>
                  <th>Balance (USD)</th>
                </tr>
              </thead>
              <tbody id="debtGoalBody"></tbody>
            </table>
          </div>
          <div class="totals-summary">
            <table class="totals-table">
              <tbody>
                <tr class="totals-row">
                  <td>Total</td>
                  <td id="debtGoalTotal">$0</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h3 style="margin-top:0.8rem;">Debt Strategy Notes</h3>
          <div id="debtNotesView" class="tiny" style="white-space:pre-wrap;"></div>
          <textarea id="debtNotesInput" class="hidden" placeholder="Notes on payoff strategy"></textarea>
        </div>
      </div> <!-- end goalsTab -->
    </div> <!-- end appContent -->
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    // === FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyDaUhACWzw3VQWf3lJWcmuSYp8ti2FxG3I",
      authDomain: "commission-calculator-2c9b5.firebaseapp.com",
      projectId: "commission-calculator-2c9b5",
      storageBucket: "commission-calculator-2c9b5.firebasestorage.app",
      messagingSenderId: "808002258792",
      appId: "1:808002258792:web:db8677e98715f06ee8f8dd",
      measurementId: "G-P1510E4556"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const compatDb = firebase.firestore();
    const db = getFirestore(app);

    const PF_401K_TARGET = 23500;
    let globalAvgMonthlyTakeHome = 0; // from comp tracker
    let globalTotalMonthlyTakeHome = 0;
    let globalMonthlyExpensesTotal = 0;

    // ---- RATE TABLE ----
    const rateTable = {
      "New": 0.00408,                // New business, any term
      "RenewalOut|Out": 0.00032,     // 0.032%
      "Renewal<100%|1-2": 0.00079,   // 0.079%
      "Renewal<100%|3+": 0.00079,    // 0.079%
      "Renewal=100%|1-2": 0.00118,   // 0.118%
      "Renewal=100%|3+": 0.00118,    // 0.118%
      "Renewal>100%|1-2": 0.00157,   // 0.157%
      "Renewal>100%|3+": 0.00157     // 0.157%
    };

    const termOptionsByType = {
      "RenewalOut": [
        { value: "Out", label: "Any-time out clause" }
      ],
      "Renewal<100%": [
        { value: "1-2", label: "1–2 years" },
        { value: "3+", label: "3+ years" }
      ],
      "Renewal=100%": [
        { value: "1-2", label: "1–2 years" },
        { value: "3+", label: "3+ years" }
      ],
      "Renewal>100%": [
        { value: "1-2", label: "1–2 years" },
        { value: "3+", label: "3+ years" }
      ]
    };

    // DOM elements
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const authStatus = document.getElementById("authStatus");
    const appContent = document.getElementById("appContent");

    const dealAmountInput = document.getElementById("dealAmount");
    const dealTypeSelect = document.getElementById("dealType");
    const dealTermSelect = document.getElementById("dealTerm");
    const termRow = document.getElementById("termRow");
    const dealNotesInput = document.getElementById("dealNotes");
    const calcBtn = document.getElementById("calcBtn");

    const rateDisplay = document.getElementById("rateDisplay");
    const totalCommissionDisplay = document.getElementById("totalCommissionDisplay");
    const totalCommissionPostTaxDisplay = document.getElementById("totalCommissionPostTaxDisplay");
    const firstMonthDisplay = document.getElementById("firstMonthDisplay");

    const historyBody = document.getElementById("historyBody");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    const totalsAmountEl = document.getElementById("totalsAmount");
    const totalsPostTaxEl = document.getElementById("totalsPostTax");
    const totalsFirstMonthEl = document.getElementById("totalsFirstMonth");

    // KPI elements
    const kpiThisMonth = document.getElementById("kpiThisMonth");
    const kpiFiscalYtd = document.getElementById("kpiFiscalYtd");
    const kpiLargestDeal = document.getElementById("kpiLargestDeal");
    const kpiFiscalYtdFirst = document.getElementById("kpiFiscalYtdFirst");

    // Comp tracker elements
    const compEditBtn = document.getElementById("compEditBtn");
    const annualTargetInput = document.getElementById("annualTarget");
    const compTableBody1 = document.getElementById("compTableBody1");
    const compTableBody2 = document.getElementById("compTableBody2");
    const compSummaryEl = document.getElementById("compSummary");
    const compEarnedLabel = document.getElementById("compEarnedLabel");
    const compRemainingLabel = document.getElementById("compRemainingLabel");
    const compAvgTakeHomeEl = document.getElementById("compAvgTakeHome");

    // Personal finances elements that need global access
    const pfMonthlyNetEl = document.getElementById("pfMonthlyNet");
    const pfAvgMonthlyTakeHomeEl = document.getElementById("pfAvgMonthlyTakeHome");
    const pfTotalMonthlyEl = document.getElementById("pfTotalMonthly");
    const pf401kTrackerInput = document.getElementById("pf401kTracker");
    const pf401kPercentEl = document.getElementById("pf401kPercent");
    const budgetPctOfIncomeEl = document.getElementById("budgetPctOfIncome");
    const budgetMonthlySurplusEl = document.getElementById("budgetMonthlySurplus");
    const goalsSortReadingBtn = document.getElementById("goalsSortReading");
    const goalsSortDebtBtn = document.getElementById("goalsSortDebt");

    // Tabs
    const tabButtons = document.querySelectorAll(".tab-button");
    const commissionTab = document.getElementById("commissionTab");
    const personalTab = document.getElementById("personalTab");
    const goalsTab = document.getElementById("goalsTab");

    let currentUser = null;

    // Comp tracker state (per user)
    const fiscalMonths = [
      "July","August","September","October","November","December",
      "January","February","March","April","May","June"
    ];

    let compConfig = {
      annualTarget: 250000,
      monthlyValues: {
        July: 6523,
        August: 9389,
        September: 26688,
        October: 17673,
        November: 0,
        December: 0,
        January: 0,
        February: 0,
        March: 0,
        April: 0,
        May: 0,
        June: 0
      }
    };

    let compEditMode = false;

    let compPieChart = null;
    let compLineChart = null;

    let commissionTrackerState = {
      annualTarget: compConfig.annualTarget || 0,
      monthlyValues: { ...compConfig.monthlyValues }
    };

    const defaultCommissionTrackerState = {
      annualTarget: compConfig.annualTarget || 0,
      monthlyValues: { ...compConfig.monthlyValues }
    };

    // --- Personal finance data from spreadsheet ---
    const incomeSummary = {
      monthlyNet: 18640,
      annualNet: 223680
    };

    let personalBudgetRows = [
      { category: "Mortgage", amount: 2483, withdraw: "5th", type: "Fixed", notes: "" },
      { category: "Electric", amount: 256, withdraw: "23rd", type: "Fixed", notes: "Average of last 12 months (analyzed June 24)" },
      { category: "Groceries and etc.", amount: 2100, withdraw: "Ongoing", type: "Fixed", notes: "Target/Teeter/Walmart/Publix" },
      { category: "Amazon", amount: 1300, withdraw: "Ongoing", type: "Variable", notes: "Misc." },
      { category: "YouTube TV", amount: 100, withdraw: "29th", type: "Fixed", notes: "$300 NFL; plus $75/month" },
      { category: "Clothes", amount: 500, withdraw: "Ongoing", type: "Variable", notes: "" },
      { category: "Kids Preschool/Activities", amount: 400, withdraw: "", type: "Fixed", notes: "" },
      { category: "Fort Mill Golf", amount: 200, withdraw: "21st", type: "Fixed", notes: "" },
      { category: "Orange Theory", amount: 150, withdraw: "12th", type: "Fixed", notes: "" },
      { category: "Chiro; massages", amount: 170, withdraw: "", type: "Fixed", notes: "" },
      { category: "Amy and Ryan Psych", amount: 180, withdraw: "", type: "Variable", notes: "" },
      { category: "Misc. Subscriptions", amount: 100, withdraw: "Ongoing", type: "Variable", notes: "Apple storage; Apple+, HBO, Audible, Canva, ChatGPT, Garmin, Sunsama" },
      { category: "DoorDash", amount: 150, withdraw: "Ongoing", type: "Variable", notes: "" },
      { category: "Eating out", amount: 650, withdraw: "Ongoing", type: "Variable", notes: "" },
      { category: "Daily Harvest", amount: 101, withdraw: "19th", type: "Fixed", notes: "" },
      { category: "Lucy", amount: 200, withdraw: "Ongoing", type: "Fixed", notes: "ie. Fetch; vet. Etc." },
      { category: "CVS", amount: 75, withdraw: "Ongoing", type: "Fixed", notes: "" },
      { category: "Netflix/Apple Music", amount: 40, withdraw: "22nd", type: "Fixed", notes: "" },
      { category: "Amy/Ryan Car Insurance", amount: 170, withdraw: "", type: "Fixed", notes: "" },
      { category: "Gas", amount: 53, withdraw: "5th", type: "Fixed", notes: "" },
      { category: "CPI", amount: 40, withdraw: "20th", type: "Fixed", notes: "" },
      { category: "Water", amount: 85, withdraw: "18th", type: "Fixed", notes: "" },
      { category: "HOA", amount: 110, withdraw: "", type: "Fixed", notes: "$330/quarter" },
      { category: "Cell/Internet", amount: 400, withdraw: "19th", type: "Fixed", notes: "Cell $337; Internet $110 ($150 Premier credit)" },
      { category: "Gas (cars) for both", amount: 100, withdraw: "Ongoing", type: "Fixed", notes: "" },
      { category: "Haircuts", amount: 100, withdraw: "Ongoing", type: "Fixed", notes: "" },
      { category: "Peloton", amount: 50, withdraw: "21st", type: "Fixed", notes: "" },
      { category: "Lawn care", amount: 150, withdraw: "Ongoing", type: "Fixed", notes: "True Green = 30; Lawn mowing = 120" },
      { category: "Life/Disability", amount: 176, withdraw: "11th", type: "Fixed", notes: "" },
      { category: "Lowes and Home Depot", amount: null, withdraw: "", type: "Variable", notes: "" },
      { category: "Amy IRA", amount: 583, withdraw: "5th", type: "Fixed", notes: "" },
      { category: "Myrtle expenses", amount: 3000, withdraw: "7th", type: "Fixed", notes: "Interest only is $1,600 (HOA; utilities)" },
      { category: "Earth Fare", amount: 150, withdraw: "Ongoing", type: "Variable", notes: "" }
    ];

    let storeSpendingRows = [
      { store: "Amazon", col1: 1176, col2: 1094, col3: 1354 },
      { store: "Teeter", col1: 829, col2: 901, col3: 996 },
      { store: "Walmart", col1: 215, col2: 18.5, col3: 564 },
      { store: "Publix", col1: 317, col2: 300, col3: 159 },
      { store: "Target", col1: 397, col2: 342, col3: 385 }
    ];

    let storePeriodHeaders = ["Period 1", "Period 2", "Period 3"];

    let debtRows = [
      { name: "Half Pint Loop Mortgage", balance: 318986 },
      { name: "Myrtle Beach Mortgage", balance: 242293 },
      { name: "Capital One", balance: null },
      { name: "Citi Credit Card", balance: null }
    ];

    let investmentRows = [
      { name: "401k", balance: null },
      { name: "529s", balance: null },
      { name: "Brokerage", balance: null },
      { name: "BOA Balance", balance: null },
      { name: "FCB Balance", balance: null },
      { name: "Myrtle Beach Checking Balance", balance: null },
      { name: "Premier 401k", balance: null },
      { name: "Half Pint Value", balance: null },
      { name: "Asheville land value", balance: null }
    ];

    let upcomingRows = Array.from({ length: 5 }).map(() => ({ category: "", amount: null }));

    let readingCompletedRows = Array.from({ length: 5 }).map(() => ({
      title: "",
      author: "",
      format: "",
      rating: "",
      monthFinished: "",
      notes: ""
    }));

    let readingToReadRows = Array.from({ length: 5 }).map(() => ({ title: "", author: "" }));

    let debtStrategyNotes = "";

    let budgetSortAmountAsc = true;
    let budgetSortCategoryAsc = true;
    let budgetSortHandlersAttached = false;
    let budgetEditMode = false;

    let readingSortAsc = true;
    let debtSortDesc = true;

    let storeEditMode = false;
    let upcomingEditMode = false;
    let debtEditMode = false;
    let investEditMode = false;
    let readingEditMode = false;
    let debtGoalEditMode = false;

    let goalsState = {
      readingCompletedRows: [],
      readingToReadRows: [],
      debtRows: [],
      debtNotes: ""
    };

    let personalFinanceState = {
      pf401k: null,
      debtNotes: "",
      budgetRows: [],
      investmentRows: [],
      readingCompletedRows: [],
      readingToReadRows: [],
      storePeriodHeaders: [],
      storeSpendingRows: [],
      upcomingRows: [],
      debtRows: []
    };

    const defaultPersonalBudgetRows = JSON.parse(JSON.stringify(personalBudgetRows));
    const defaultInvestmentRows = JSON.parse(JSON.stringify(investmentRows));
    const defaultReadingCompletedRows = JSON.parse(JSON.stringify(readingCompletedRows));
    const defaultReadingToReadRows = JSON.parse(JSON.stringify(readingToReadRows));
    const defaultStoreSpendingRows = JSON.parse(JSON.stringify(storeSpendingRows));
    const defaultStorePeriodHeaders = [...storePeriodHeaders];
    const defaultUpcomingRows = JSON.parse(JSON.stringify(upcomingRows));
    const defaultDebtRows = JSON.parse(JSON.stringify(debtRows));
    const defaultGoalsState = {
      readingCompletedRows: JSON.parse(JSON.stringify(defaultReadingCompletedRows)),
      readingToReadRows: JSON.parse(JSON.stringify(defaultReadingToReadRows)),
      debtRows: JSON.parse(JSON.stringify(defaultDebtRows)),
      debtNotes: ""
    };

    function resetPersonalFinanceState() {
      personalFinanceState = {
        pf401k: null,
        debtNotes: "",
        budgetRows: JSON.parse(JSON.stringify(defaultPersonalBudgetRows)),
        investmentRows: JSON.parse(JSON.stringify(defaultInvestmentRows)),
        readingCompletedRows: JSON.parse(JSON.stringify(defaultReadingCompletedRows)),
        readingToReadRows: JSON.parse(JSON.stringify(defaultReadingToReadRows)),
        storeSpendingRows: JSON.parse(JSON.stringify(defaultStoreSpendingRows)),
        storePeriodHeaders: [...defaultStorePeriodHeaders],
        upcomingRows: JSON.parse(JSON.stringify(defaultUpcomingRows)),
        debtRows: JSON.parse(JSON.stringify(defaultDebtRows))
      };
      personalBudgetRows = JSON.parse(JSON.stringify(defaultPersonalBudgetRows));
      investmentRows = JSON.parse(JSON.stringify(defaultInvestmentRows));
      readingCompletedRows = JSON.parse(JSON.stringify(defaultReadingCompletedRows));
      readingToReadRows = JSON.parse(JSON.stringify(defaultReadingToReadRows));
      storeSpendingRows = JSON.parse(JSON.stringify(defaultStoreSpendingRows));
      storePeriodHeaders = [...defaultStorePeriodHeaders];
      upcomingRows = JSON.parse(JSON.stringify(defaultUpcomingRows));
      debtRows = JSON.parse(JSON.stringify(defaultDebtRows));
      debtStrategyNotes = "";
      if (pf401kTrackerInput) {
        pf401kTrackerInput.value = "";
        updatePf401kInfo();
      }
    }

    function buildCommissionTrackerStateFromDOM() {
      return {
        annualTarget: typeof compConfig.annualTarget === "number" ? compConfig.annualTarget : 0,
        monthlyValues: { ...compConfig.monthlyValues }
      };
    }

    function applyCommissionTrackerStateToDOM(state) {
      const safeState = state || {};
      const incomingMonthly = safeState.monthlyValues || {};
      commissionTrackerState = {
        annualTarget: typeof safeState.annualTarget === "number"
          ? safeState.annualTarget
          : defaultCommissionTrackerState.annualTarget,
        monthlyValues: {
          ...defaultCommissionTrackerState.monthlyValues,
          ...Object.keys(incomingMonthly).reduce((acc, key) => {
            const val = incomingMonthly[key];
            acc[key] = typeof val === "number" ? val : 0;
            return acc;
          }, {})
        }
      };

      compConfig.annualTarget = commissionTrackerState.annualTarget;
      compConfig.monthlyValues = { ...commissionTrackerState.monthlyValues };

      renderCompTracker();
    }

    async function loadCommissionTrackerDataForUser(uid) {
      try {
        const ref = doc(db, "dashboards", uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          if (data.commissionTracker) {
            commissionTrackerState = data.commissionTracker;
            applyCommissionTrackerStateToDOM(commissionTrackerState);
          } else {
            commissionTrackerState = buildCommissionTrackerStateFromDOM();
            await setDoc(ref, { commissionTracker: commissionTrackerState }, { merge: true });
          }
        } else {
          commissionTrackerState = buildCommissionTrackerStateFromDOM();
          await setDoc(ref, { commissionTracker: commissionTrackerState });
        }
      } catch (err) {
        console.error("Error loading commission tracker data", err);
        alert("There was a problem loading your data. Please refresh and try again.");
      }
    }

    async function saveCommissionTrackerDataForUser(uid) {
      const ref = doc(db, "dashboards", uid);
      commissionTrackerState = buildCommissionTrackerStateFromDOM();
      await setDoc(ref, { commissionTracker: commissionTrackerState }, { merge: true });
    }

    function buildPersonalFinanceStateFromDOM() {
      const pf401kValue = pf401kTrackerInput ? getNumericValue(pf401kTrackerInput.value) : null;
      return {
        pf401k: isNaN(pf401kValue) ? null : pf401kValue,
        debtNotes: debtStrategyNotes || "",
        budgetRows: personalBudgetRows.map(row => ({
          category: row.category || "",
          amount: typeof row.amount === "number" ? row.amount : null,
          withdraw: row.withdraw || "",
          type: row.type || "",
          notes: row.notes || ""
        })),
        investmentRows: investmentRows.map(row => ({
          name: row.name || "",
          balance: typeof row.balance === "number" ? row.balance : null
        })),
        readingCompletedRows: readingCompletedRows.map(row => ({
          title: row.title || "",
          author: row.author || "",
          format: row.format || "",
          rating: row.rating || "",
          monthFinished: row.monthFinished || "",
          notes: row.notes || ""
        })),
        readingToReadRows: readingToReadRows.map(row => ({
          title: row.title || "",
          author: row.author || ""
        })),
        storePeriodHeaders: [...storePeriodHeaders],
        storeSpendingRows: storeSpendingRows.map(row => ({
          store: row.store || "",
          col1: typeof row.col1 === "number" ? row.col1 : null,
          col2: typeof row.col2 === "number" ? row.col2 : null,
          col3: typeof row.col3 === "number" ? row.col3 : null
        })),
        upcomingRows: upcomingRows.map(row => ({
          category: row.category || "",
          amount: typeof row.amount === "number" ? row.amount : null
        })),
        debtRows: debtRows.map(row => ({
          name: row.name || "",
          balance: typeof row.balance === "number" ? row.balance : null
        }))
      };
    }

    function applyPersonalFinanceStateToDOM(state) {
      const safeState = state || {};
      personalFinanceState = {
        pf401k: typeof safeState.pf401k === "number" ? safeState.pf401k : null,
        debtNotes: typeof safeState.debtNotes === "string" ? safeState.debtNotes : "",
        budgetRows: Array.isArray(safeState.budgetRows) && safeState.budgetRows.length
          ? safeState.budgetRows.map(row => ({
              category: row.category || "",
              amount: typeof row.amount === "number" ? row.amount : null,
              withdraw: row.withdraw || "",
              type: row.type || "",
              notes: row.notes || ""
            }))
          : JSON.parse(JSON.stringify(defaultPersonalBudgetRows)),
        investmentRows: Array.isArray(safeState.investmentRows) && safeState.investmentRows.length
          ? safeState.investmentRows.map(row => ({
              name: row.name || "",
              balance: typeof row.balance === "number" ? row.balance : null
            }))
          : JSON.parse(JSON.stringify(defaultInvestmentRows)),
        readingCompletedRows: Array.isArray(safeState.readingCompletedRows) && safeState.readingCompletedRows.length
          ? safeState.readingCompletedRows.map(row => ({
              title: row.title || "",
              author: row.author || "",
              format: row.format || "",
              rating: row.rating || "",
              monthFinished: row.monthFinished || "",
              notes: row.notes || ""
            }))
          : JSON.parse(JSON.stringify(defaultReadingCompletedRows)),
        readingToReadRows: Array.isArray(safeState.readingToReadRows) && safeState.readingToReadRows.length
          ? safeState.readingToReadRows.map(row => ({
              title: row.title || "",
              author: row.author || ""
            }))
          : JSON.parse(JSON.stringify(defaultReadingToReadRows)),
        storePeriodHeaders: Array.isArray(safeState.storePeriodHeaders) && safeState.storePeriodHeaders.length
          ? [...safeState.storePeriodHeaders]
          : [...defaultStorePeriodHeaders],
        storeSpendingRows: Array.isArray(safeState.storeSpendingRows) && safeState.storeSpendingRows.length
          ? safeState.storeSpendingRows.map(row => ({
              store: row.store || "",
              col1: typeof row.col1 === "number" ? row.col1 : null,
              col2: typeof row.col2 === "number" ? row.col2 : null,
              col3: typeof row.col3 === "number" ? row.col3 : null
            }))
          : JSON.parse(JSON.stringify(defaultStoreSpendingRows)),
        upcomingRows: Array.isArray(safeState.upcomingRows) && safeState.upcomingRows.length
          ? safeState.upcomingRows.map(row => ({
              category: row.category || "",
              amount: typeof row.amount === "number" ? row.amount : null
            }))
          : JSON.parse(JSON.stringify(defaultUpcomingRows)),
        debtRows: Array.isArray(safeState.debtRows) && safeState.debtRows.length
          ? safeState.debtRows.map(row => ({
              name: row.name || "",
              balance: typeof row.balance === "number" ? row.balance : null
            }))
          : JSON.parse(JSON.stringify(defaultDebtRows))
      };

      personalBudgetRows = personalFinanceState.budgetRows;
      investmentRows = personalFinanceState.investmentRows;
      readingCompletedRows = personalFinanceState.readingCompletedRows;
      readingToReadRows = personalFinanceState.readingToReadRows;
      storeSpendingRows = personalFinanceState.storeSpendingRows;
      storePeriodHeaders = personalFinanceState.storePeriodHeaders;
      upcomingRows = personalFinanceState.upcomingRows;
      debtRows = personalFinanceState.debtRows;
      debtStrategyNotes = personalFinanceState.debtNotes || "";

      if (pf401kTrackerInput) {
        pf401kTrackerInput.value = personalFinanceState.pf401k != null
          ? formatNumberWithCommas(personalFinanceState.pf401k.toString())
          : "";
      }

      renderPersonalFinance();
      renderGoals();
      updatePf401kInfo();
    }

    async function loadPersonalFinanceDataForUser(uid) {
      try {
        const ref = doc(db, "dashboards", uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          if (data.personalFinances) {
            personalFinanceState = data.personalFinances;
            applyPersonalFinanceStateToDOM(personalFinanceState);
          } else {
            personalFinanceState = buildPersonalFinanceStateFromDOM();
            await setDoc(ref, { personalFinances: personalFinanceState }, { merge: true });
          }
        } else {
          personalFinanceState = buildPersonalFinanceStateFromDOM();
          await setDoc(ref, { personalFinances: personalFinanceState });
        }
      } catch (err) {
        console.error("Error loading personal finance data", err);
        alert("There was a problem loading your data. Please refresh and try again.");
      }
    }

    async function savePersonalFinanceDataForUser(uid) {
      const ref = doc(db, "dashboards", uid);
      personalFinanceState = buildPersonalFinanceStateFromDOM();
      await setDoc(ref, { personalFinances: personalFinanceState }, { merge: true });
    }

    function buildGoalsStateFromDOM() {
      return {
        readingCompletedRows: readingCompletedRows.map(row => ({
          title: row.title || "",
          author: row.author || "",
          format: row.format || "",
          rating: row.rating || "",
          monthFinished: row.monthFinished || "",
          notes: row.notes || ""
        })),
        readingToReadRows: readingToReadRows.map(row => ({
          title: row.title || "",
          author: row.author || ""
        })),
        debtRows: debtRows.map(row => ({
          name: row.name || "",
          balance: typeof row.balance === "number" ? row.balance : null
        })),
        debtNotes: debtStrategyNotes || ""
      };
    }

    function applyGoalsStateToDOM(state) {
      const safeState = state || {};
      goalsState = {
        readingCompletedRows: Array.isArray(safeState.readingCompletedRows) && safeState.readingCompletedRows.length
          ? safeState.readingCompletedRows.map(row => ({
              title: row.title || "",
              author: row.author || "",
              format: row.format || "",
              rating: row.rating || "",
              monthFinished: row.monthFinished || "",
              notes: row.notes || ""
            }))
          : JSON.parse(JSON.stringify(defaultGoalsState.readingCompletedRows)),
        readingToReadRows: Array.isArray(safeState.readingToReadRows) && safeState.readingToReadRows.length
          ? safeState.readingToReadRows.map(row => ({
              title: row.title || "",
              author: row.author || ""
            }))
          : JSON.parse(JSON.stringify(defaultGoalsState.readingToReadRows)),
        debtRows: Array.isArray(safeState.debtRows) && safeState.debtRows.length
          ? safeState.debtRows.map(row => ({
              name: row.name || "",
              balance: typeof row.balance === "number" ? row.balance : null
            }))
          : JSON.parse(JSON.stringify(defaultGoalsState.debtRows)),
        debtNotes: typeof safeState.debtNotes === "string"
          ? safeState.debtNotes
          : defaultGoalsState.debtNotes
      };

      readingCompletedRows = goalsState.readingCompletedRows;
      readingToReadRows = goalsState.readingToReadRows;
      debtRows = goalsState.debtRows;
      debtStrategyNotes = goalsState.debtNotes || "";

      personalFinanceState = {
        ...personalFinanceState,
        readingCompletedRows,
        readingToReadRows,
        debtRows,
        debtNotes: debtStrategyNotes
      };

      renderPersonalFinance();
      renderGoals();
    }

    async function loadGoalsDataForUser(uid) {
      try {
        const ref = doc(db, "dashboards", uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          if (data.goals) {
            goalsState = data.goals;
            applyGoalsStateToDOM(goalsState);
          } else {
            goalsState = buildGoalsStateFromDOM();
            await setDoc(ref, { goals: goalsState }, { merge: true });
          }
        } else {
          goalsState = buildGoalsStateFromDOM();
          await setDoc(ref, { goals: goalsState });
        }
      } catch (err) {
        console.error("Error loading goals data", err);
        alert("There was a problem loading your data. Please refresh and try again.");
      }
    }

    async function saveGoalsDataForUser(uid) {
      const ref = doc(db, "dashboards", uid);
      goalsState = buildGoalsStateFromDOM();
      await setDoc(ref, { goals: goalsState }, { merge: true });
    }

    // --- Helpers ---
    function formatNumberWithCommas(value) {
      if (value === "") return "";
      const numeric = value.replace(/,/g, "").replace(/[^\d.]/g, "");
      if (numeric === "") return "";
      const parts = numeric.split(".");
      const intPart = parts[0];
      const decPart = parts[1] || "";
      const intFormatted = parseInt(intPart, 10).toLocaleString("en-US");
      return decPart ? intFormatted + "." + decPart.slice(0, 2) : intFormatted;
    }

    function getNumericValue(str) {
      if (!str) return NaN;
      const cleaned = str.replace(/,/g, "");
      return parseFloat(cleaned);
    }

    function formatCurrency(amount) {
      if (isNaN(amount)) return "$0";
      const rounded = Math.round(amount);
      return "$" + rounded.toLocaleString("en-US");
    }

    function escapeHtml(str) {
      if (!str) return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function updateBudgetPctOfIncome() {
      if (!budgetPctOfIncomeEl && !budgetMonthlySurplusEl) return;
      if (!globalTotalMonthlyTakeHome || globalTotalMonthlyTakeHome <= 0) {
        if (budgetPctOfIncomeEl) {
          budgetPctOfIncomeEl.textContent = "—";
        }
        if (budgetMonthlySurplusEl) {
          budgetMonthlySurplusEl.textContent = formatCurrency(-globalMonthlyExpensesTotal);
        }
        return;
      }
      const pct = (globalMonthlyExpensesTotal / globalTotalMonthlyTakeHome) * 100;
      if (budgetPctOfIncomeEl) {
        budgetPctOfIncomeEl.textContent = pct.toFixed(1) + "%";
      }
      if (budgetMonthlySurplusEl) {
        const surplus = globalTotalMonthlyTakeHome - globalMonthlyExpensesTotal;
        budgetMonthlySurplusEl.textContent = formatCurrency(surplus);
      }
    }

    function updatePf401kInfo() {
      if (!pf401kTrackerInput || !pf401kPercentEl) return;
      const val = getNumericValue(pf401kTrackerInput.value);
      const contributed = isNaN(val) ? 0 : val;
      const pct = PF_401K_TARGET > 0 ? (contributed / PF_401K_TARGET) * 100 : 0;
      pf401kPercentEl.textContent = pct.toFixed(1) + "%";
    }

    // --- Term dropdown handling ---
    function populateTerms() {
      const type = dealTypeSelect.value;

      if (type === "New") {
        termRow.classList.add("hidden");
        dealTermSelect.innerHTML = "";
        return;
      }

      termRow.classList.remove("hidden");
      const options = termOptionsByType[type] || [];
      dealTermSelect.innerHTML = options
        .map(o => `<option value="${o.value}">${o.label}</option>`)
        .join("");
    }

    dealTypeSelect.addEventListener("change", populateTerms);

    // Ensure commas for deal amount
    dealAmountInput.addEventListener("input", (e) => {
      e.target.value = formatNumberWithCommas(e.target.value);
    });
    dealAmountInput.addEventListener("blur", (e) => {
      e.target.value = formatNumberWithCommas(e.target.value);
    });

    // --- Firestore helpers for History ---
    async function fetchHistory() {
      if (!currentUser) return [];
      const snapshot = await compatDb.collection("deals")
        .where("userId", "==", currentUser.uid)
        .get();

      const items = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      items.sort((a, b) => {
        const ta = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });

      return items;
    }

    async function deleteEntry(id) {
      if (!currentUser) return;
      try {
        await compatDb.collection("deals").doc(id).delete();
        await renderHistory();
      } catch (err) {
        console.error("Error deleting entry", err);
        alert("Error deleting entry.");
      }
    }

    async function clearHistoryForUser() {
      if (!currentUser) return;
      const snapshot = await compatDb.collection("deals")
        .where("userId", "==", currentUser.uid)
        .get();

      const batch = compatDb.batch();
      snapshot.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      await renderHistory();
    }

    clearHistoryBtn.addEventListener("click", () => {
      if (confirm("Clear all saved history for this account?")) {
        clearHistoryForUser();
      }
    });

    function isSameMonthYear(date, now) {
      return (
        date.getFullYear() === now.getFullYear() &&
        date.getMonth() === now.getMonth()
      );
    }

    function getFiscalYearStart(now) {
      const year = now.getFullYear();
      if (now.getMonth() >= 6) {
        return new Date(year, 6, 1);
      } else {
        return new Date(year - 1, 6, 1);
      }
    }

    function isInFiscalYear(date, now) {
      const fyStart = getFiscalYearStart(now);
      return date >= fyStart && date <= now;
    }

    async function renderHistory() {
      if (!currentUser) {
        historyBody.innerHTML = `
          <tr>
            <td colspan="8" style="opacity:0.7;">Sign in to see your history.</td>
          </tr>`;
        totalsAmountEl.textContent = "$0";
        totalsPostTaxEl.textContent = "$0";
        totalsFirstMonthEl.textContent = "$0";
        kpiThisMonth.textContent = "$0";
        kpiFiscalYtd.textContent = "$0";
        kpiLargestDeal.textContent = "$0";
        kpiFiscalYtdFirst.textContent = "$0";
        return;
      }

      const history = await fetchHistory();
      historyBody.innerHTML = "";

      if (!history.length) {
        historyBody.innerHTML = `
          <tr>
            <td colspan="8" style="opacity:0.7;">No deals recorded yet.</td>
          </tr>`;
        totalsAmountEl.textContent = "$0";
        totalsPostTaxEl.textContent = "$0";
        totalsFirstMonthEl.textContent = "$0";
        kpiThisMonth.textContent = "$0";
        kpiFiscalYtd.textContent = "$0";
        kpiLargestDeal.textContent = "$0";
        kpiFiscalYtdFirst.textContent = "$0";
        return;
      }

      let totalAmount = 0;
      let totalPostTax = 0;
      let totalFirstMonth = 0;

      let thisMonthPostTax = 0;
      let fiscalYtdPostTax = 0;
      let fiscalYtdFirstMonth = 0;
      let largestDealAmount = 0;

      const now = new Date();

      let rowsHtml = "";

      history.forEach(entry => {
        totalAmount += entry.amount || 0;
        totalPostTax += entry.totalPostTax || 0;
        totalFirstMonth += entry.firstMonthPostTax || 0;

        const createdDate = entry.createdAt && entry.createdAt.toDate ? entry.createdAt.toDate() : null;
        if (createdDate) {
          if (isSameMonthYear(createdDate, now)) {
            thisMonthPostTax += entry.totalPostTax || 0;
          }
          if (isInFiscalYear(createdDate, now)) {
            fiscalYtdPostTax += entry.totalPostTax || 0;
            fiscalYtdFirstMonth += entry.firstMonthPostTax || 0;
          }
        }

        if (entry.amount && entry.amount > largestDealAmount) {
          largestDealAmount = entry.amount;
        }

        const safeDate = escapeHtml(entry.date || "");
        const safeType = escapeHtml(entry.dealType || "");
        const safeTerm = escapeHtml(entry.termLabel || entry.termValue || "");
        const safeNotes = escapeHtml(entry.notes || "");

        rowsHtml += `
          <tr>
            <td>${safeDate}</td>
            <td>${safeType}</td>
            <td>${safeTerm}</td>
            <td>${formatCurrency(entry.amount)}</td>
            <td>${formatCurrency(entry.totalPostTax)}</td>
            <td>${formatCurrency(entry.firstMonthPostTax)}</td>
            <td title="${safeNotes}">${safeNotes}</td>
            <td>
              <button class="delete-btn" onclick="deleteEntry('${entry.id}')">x</button>
            </td>
          </tr>
        `;
      });

      historyBody.innerHTML = rowsHtml;

      totalsAmountEl.textContent = formatCurrency(totalAmount);
      totalsPostTaxEl.textContent = formatCurrency(totalPostTax);
      totalsFirstMonthEl.textContent = formatCurrency(totalFirstMonth);

      kpiThisMonth.textContent = formatCurrency(thisMonthPostTax);
      kpiFiscalYtd.textContent = formatCurrency(fiscalYtdPostTax);
      kpiLargestDeal.textContent = formatCurrency(largestDealAmount);
      kpiFiscalYtdFirst.textContent = formatCurrency(fiscalYtdFirstMonth);
    }

    window.deleteEntry = deleteEntry;

    // --- Main calculation ---
    calcBtn.addEventListener("click", async () => {
      if (!currentUser) {
        alert("Please sign in first.");
        return;
      }

      const amount = getNumericValue(dealAmountInput.value);

      if (isNaN(amount) || amount <= 0) {
        alert("Please enter a deal amount greater than 0.");
        return;
      }

      const type = dealTypeSelect.value;
      let termValue = "";
      let key = "";

      if (type === "New") {
        key = "New";
        termValue = "Any";
      } else {
        termValue = dealTermSelect.value;
        key = `${type}|${termValue}`;
      }

      const rate = rateTable[key];

      if (rate === undefined) {
        alert("No rate found for this combination of deal type and term.");
        return;
      }

      const notes = dealNotesInput.value.trim();

      const totalCommission = amount * rate;
      const totalCommissionPostTax = totalCommission * 0.66;

      // First-month logic:
      // - New business: 50% of post-tax in month 1
      // - Renewals: 100% of post-tax in month 1
      let firstMonthCommission;
      if (type.startsWith("Renewal")) {
        firstMonthCommission = totalCommissionPostTax;
      } else {
        firstMonthCommission = totalCommissionPostTax * 0.5;
      }

      rateDisplay.textContent = (rate * 100).toFixed(3) + "%";
      totalCommissionDisplay.textContent = formatCurrency(totalCommission);
      totalCommissionPostTaxDisplay.textContent = formatCurrency(totalCommissionPostTax);
      firstMonthDisplay.textContent = formatCurrency(firstMonthCommission);

      const now = new Date();
      const dateStr = now.toLocaleString("en-US", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });

      const entry = {
        userId: currentUser.uid,
        date: dateStr,
        dealType: type,
        termValue: termValue,
        notes: notes,
        amount: amount,
        totalPostTax: totalCommissionPostTax,
        firstMonthPostTax: firstMonthCommission,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await compatDb.collection("deals").add(entry);
      await renderHistory();
    });

    // --- Comp Tracker Firestore helpers ---
    async function loadCompTracker() {
      if (!currentUser) return;

      await loadCommissionTrackerDataForUser(currentUser.uid);
    }

    async function saveCompTracker() {
      if (!currentUser) return;
      await saveCommissionTrackerDataForUser(currentUser.uid);
    }

    function updateCompEditingState() {
      const disabled = !compEditMode;

      document.querySelectorAll(".comp-month-input").forEach(input => {
        input.disabled = disabled;
        input.classList.toggle("readonly-input", disabled);
      });

      if (annualTargetInput) {
        annualTargetInput.disabled = disabled;
        annualTargetInput.classList.toggle("readonly-input", disabled);
      }

      if (compEditBtn) {
        compEditBtn.textContent = compEditMode
          ? "Done editing monthly amounts"
          : "Edit amounts";
      }
    }

    function persistCompInputs() {
      document.querySelectorAll(".comp-month-input").forEach(input => {
        const month = input.getAttribute("data-month");
        const val = getNumericValue(input.value);
        compConfig.monthlyValues[month] = isNaN(val) ? 0 : val;
      });

      if (annualTargetInput) {
        const val = getNumericValue(annualTargetInput.value);
        compConfig.annualTarget = isNaN(val) ? 0 : val;
      }
    }

    function updateCompTakeHomeCells() {
      document.querySelectorAll(".comp-take-home").forEach(cell => {
        const month = cell.getAttribute("data-month");
        const v = compConfig.monthlyValues[month] || 0;
        const takeHome = v * 0.66;
        cell.textContent = v ? formatCurrency(takeHome) : "$0";
      });
    }

    function renderCompTracker() {
      // Annual target input
      annualTargetInput.value = formatNumberWithCommas(
        (compConfig.annualTarget || 0).toString()
      );

      // Build month tables
      let rowsHtml1 = "";
      let rowsHtml2 = "";
      fiscalMonths.forEach((monthName, idx) => {
        const value = compConfig.monthlyValues[monthName] || 0;
        const disabledAttr = compEditMode ? "" : "disabled";
        const inputClasses = compEditMode ? "comp-month-input" : "comp-month-input readonly-input";
        const row = `
          <tr>
            <td>${monthName}</td>
            <td>
              <input
                type="text"
                class="${inputClasses}"
                data-month="${monthName}"
                ${disabledAttr}
                value="${value ? formatNumberWithCommas(value.toString()) : ""}"
              />
            </td>
            <td class="comp-take-home" data-month="${monthName}">$0</td>
          </tr>
        `;
        if (idx < 6) {
          rowsHtml1 += row;
        } else {
          rowsHtml2 += row;
        }
      });
      compTableBody1.innerHTML = rowsHtml1;
      compTableBody2.innerHTML = rowsHtml2;

      // Attach listeners to month inputs
      document.querySelectorAll(".comp-month-input").forEach(input => {
        input.addEventListener("input", (e) => {
          const formatted = formatNumberWithCommas(e.target.value);
          e.target.value = formatted;
          const month = e.target.getAttribute("data-month");
          const val = getNumericValue(e.target.value);
          compConfig.monthlyValues[month] = isNaN(val) ? 0 : val;
          updateCompTakeHomeCells();
          updateCompChartsAndSummary();
        });
        input.addEventListener("blur", async (e) => {
          const month = e.target.getAttribute("data-month");
          const val = getNumericValue(e.target.value);
          compConfig.monthlyValues[month] = isNaN(val) ? 0 : val;
          updateCompTakeHomeCells();
          await saveCompTracker();
          updateCompChartsAndSummary();
        });
      });

      annualTargetInput.addEventListener("input", (e) => {
        const formatted = formatNumberWithCommas(e.target.value);
        e.target.value = formatted;
      });
      annualTargetInput.addEventListener("blur", async (e) => {
        const val = getNumericValue(e.target.value);
        compConfig.annualTarget = isNaN(val) ? 0 : val;
        await saveCompTracker();
        updateCompChartsAndSummary();
      });

      updateCompEditingState();
      updateCompTakeHomeCells();
      updateCompChartsAndSummary();
    }

    if (compEditBtn) {
      compEditBtn.addEventListener("click", async () => {
        if (!compEditMode) {
          compEditMode = true;
          updateCompEditingState();
          const firstMonthInput = document.querySelector(".comp-month-input");
          if (firstMonthInput) {
            firstMonthInput.focus();
          }
          return;
        }

        persistCompInputs();
        updateCompTakeHomeCells();
        await saveCompTracker();
        updateCompChartsAndSummary();
        compEditMode = false;
        updateCompEditingState();
      });
    }

    function updatePersonalIncomePills() {
      if (pfMonthlyNetEl) {
        pfMonthlyNetEl.textContent = formatCurrency(incomeSummary.monthlyNet);
      }
      if (pfAvgMonthlyTakeHomeEl) {
        pfAvgMonthlyTakeHomeEl.textContent =
          globalAvgMonthlyTakeHome > 0 ? formatCurrency(globalAvgMonthlyTakeHome) : "$0";
      }
      if (pfTotalMonthlyEl) {
        const total = (incomeSummary.monthlyNet || 0) + (globalAvgMonthlyTakeHome || 0);
        pfTotalMonthlyEl.textContent = formatCurrency(total);
        globalTotalMonthlyTakeHome = total;
      }
      updateBudgetPctOfIncome();
    }

    function updateCompChartsAndSummary() {
      const annualTarget = compConfig.annualTarget || 0;
      let earned = 0;
      const monthlyRaw = [];
      fiscalMonths.forEach(m => {
        const v = compConfig.monthlyValues[m] || 0;
        earned += v;
        monthlyRaw.push(v);
      });
      const remaining = Math.max(annualTarget - earned, 0);

      const pct = annualTarget > 0 ? (earned / annualTarget) * 100 : 0;
      const pctText = annualTarget > 0 ? pct.toFixed(1) + "%" : "—";

      compSummaryEl.textContent =
        "YTD variable: " + formatCurrency(earned) +
        " of " + formatCurrency(annualTarget) +
        " (" + pctText + " of target).";

      // Update big labels next to pie chart
      if (compEarnedLabel) {
        compEarnedLabel.textContent = formatCurrency(earned);
      }
      if (compRemainingLabel) {
        compRemainingLabel.textContent = formatCurrency(remaining);
      }

      // Average monthly take-home (post tax, 66% of monthly) based ONLY on months with data
      const monthlyTakeHomes = monthlyRaw.map(v => v * 0.66);
      const nonZeroTakeHomes = monthlyTakeHomes.filter(v => v > 0);
      const avgTakeHome = nonZeroTakeHomes.length
        ? nonZeroTakeHomes.reduce((a, b) => a + b, 0) / nonZeroTakeHomes.length
        : 0;

      globalAvgMonthlyTakeHome = avgTakeHome || 0;
      if (compAvgTakeHomeEl) {
        compAvgTakeHomeEl.textContent = formatCurrency(globalAvgMonthlyTakeHome);
      }
      updatePersonalIncomePills();

      // --- Pie chart (Earned vs Remaining) ---
      const pieCtx = document.getElementById("compPieChart").getContext("2d");
      const pieData = [earned, remaining];

      if (!compPieChart) {
        compPieChart = new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: ["Earned", "Remaining"],
            datasets: [{
              data: pieData,
              backgroundColor: ["#22c55e", "#ef4444"],
              borderWidth: 0
            }]
          },
          options: {
            plugins: {
              legend: {
                position: "bottom"
              }
            },
            cutout: "60%"
          }
        });
      } else {
        compPieChart.data.datasets[0].data = pieData;
        compPieChart.update();
      }

      // --- Line chart (CUMULATIVE target vs actual) ---
      const lineCtx = document.getElementById("compLineChart").getContext("2d");
      const monthlyTarget = annualTarget > 0 ? (annualTarget / 12) : 0;

      // Build cumulative target
      const targetSeries = [];
      let runningTarget = 0;
      for (let i = 0; i < 12; i++) {
        runningTarget += monthlyTarget;
        targetSeries.push(runningTarget);
      }

      // Build cumulative actuals
      const monthlyActualsCumulative = [];
      let runningActual = 0;
      for (let i = 0; i < monthlyRaw.length; i++) {
        runningActual += monthlyRaw[i];
        monthlyActualsCumulative.push(runningActual);
      }

      // Build projected cumulative based on average of completed months
      let completedSum = 0;
      let completedCount = 0;
      const projectedMonthly = [];
      monthlyRaw.forEach(val => {
        if (val > 0) {
          completedSum += val;
          completedCount += 1;
          projectedMonthly.push(val);
        } else {
          const avg = completedCount ? completedSum / completedCount : 0;
          projectedMonthly.push(avg);
        }
      });

      const projectedCumulative = [];
      let runningProjected = 0;
      for (let i = 0; i < projectedMonthly.length; i++) {
        runningProjected += projectedMonthly[i];
        projectedCumulative.push(runningProjected);
      }

      if (!compLineChart) {
        compLineChart = new Chart(lineCtx, {
          type: "line",
          data: {
            labels: fiscalMonths,
            datasets: [
              {
                label: "Cumulative target",
                data: targetSeries,
                tension: 0.2,
                borderColor: "#2563eb",
                backgroundColor: "transparent",
                pointBackgroundColor: "#2563eb",
                borderWidth: 2
              },
              {
                label: "Cumulative actual",
                data: monthlyActualsCumulative,
                tension: 0.2,
                borderColor: "#22c55e",
                backgroundColor: "transparent",
                pointBackgroundColor: "#22c55e",
                borderWidth: 2
              },
              {
                label: "Projected (avg of completed months)",
                data: projectedCumulative,
                tension: 0.2,
                borderColor: "#9ca3af",
                backgroundColor: "transparent",
                borderDash: [6, 4],
                pointBackgroundColor: "#9ca3af",
                borderWidth: 2
              }
            ]
          },
          options: {
            plugins: {
              legend: {
                position: "bottom"
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 250000,
                ticks: {
                  stepSize: 25000,
                  font: {
                    size: 10
                  }
                }
              },
              x: {
                ticks: {
                  font: {
                    size: 10
                  }
                }
              }
            }
          }
        });
      } else {
        compLineChart.data.datasets[0].data = targetSeries;
        compLineChart.data.datasets[1].data = monthlyActualsCumulative;
        if (compLineChart.data.datasets.length < 3) {
          compLineChart.data.datasets.push({
            label: "Projected (avg of completed months)",
            data: projectedCumulative,
            tension: 0.2,
            borderColor: "#9ca3af",
            backgroundColor: "transparent",
            borderDash: [6, 4],
            pointBackgroundColor: "#9ca3af",
            borderWidth: 2
          });
        } else {
          compLineChart.data.datasets[2].data = projectedCumulative;
          compLineChart.data.datasets[2].borderColor = "#9ca3af";
          compLineChart.data.datasets[2].backgroundColor = "transparent";
          compLineChart.data.datasets[2].borderDash = [6, 4];
          compLineChart.data.datasets[2].pointBackgroundColor = "#9ca3af";
          compLineChart.data.datasets[2].borderWidth = 2;
        }
        compLineChart.data.datasets[0].borderColor = "#2563eb";
        compLineChart.data.datasets[0].backgroundColor = "transparent";
        compLineChart.data.datasets[0].pointBackgroundColor = "#2563eb";
        compLineChart.data.datasets[0].borderWidth = 2;
        compLineChart.data.datasets[1].borderColor = "#22c55e";
        compLineChart.data.datasets[1].backgroundColor = "transparent";
        compLineChart.data.datasets[1].pointBackgroundColor = "#22c55e";
        compLineChart.data.datasets[1].borderWidth = 2;
        compLineChart.options.scales.y.max = 250000;
        compLineChart.options.scales.y.ticks.stepSize = 25000;
        compLineChart.options.scales.y.ticks.font.size = 10;
        compLineChart.options.scales.x.ticks.font.size = 10;
        compLineChart.update();
      }
    }

    // --- Personal finances rendering ---
    let pf401kListenersAttached = false;

    async function savePersonalFinanceData(updates = {}) {
      if (!currentUser) return;
      if (updates.budgetRows) personalBudgetRows = updates.budgetRows;
      if (updates.investmentRows) investmentRows = updates.investmentRows;
      if (updates.readingCompletedRows) readingCompletedRows = updates.readingCompletedRows;
      if (updates.readingToReadRows) readingToReadRows = updates.readingToReadRows;
      if (updates.storeSpendingRows) storeSpendingRows = updates.storeSpendingRows;
      if (updates.storePeriodHeaders) storePeriodHeaders = updates.storePeriodHeaders;
      if (updates.upcomingRows) upcomingRows = updates.upcomingRows;
      if (updates.debtRows) debtRows = updates.debtRows;
      if (typeof updates.debtNotes === "string") debtStrategyNotes = updates.debtNotes;
      if (typeof updates.pf401k === "number" && pf401kTrackerInput) {
        pf401kTrackerInput.value = formatNumberWithCommas(updates.pf401k.toString());
      }

      try {
        await savePersonalFinanceDataForUser(currentUser.uid);
      } catch (err) {
        console.error("Error saving personal finance data", err);
        alert("There was a problem saving your data. Please try again.");
      }
    }

    async function loadPersonalFinanceData() {
      if (!currentUser) return;
      await loadPersonalFinanceDataForUser(currentUser.uid);
    }

    function attachPf401kListeners() {
      if (!pf401kTrackerInput || pf401kListenersAttached) return;
      pf401kTrackerInput.addEventListener("input", (e) => {
        e.target.value = formatNumberWithCommas(e.target.value);
        updatePf401kInfo();
      });
      pf401kTrackerInput.addEventListener("blur", async (e) => {
        const val = getNumericValue(e.target.value);
        const numeric = isNaN(val) ? null : val;
        updatePf401kInfo();
        await savePersonalFinanceData({ pf401k: numeric });
      });
      pf401kListenersAttached = true;
      updatePf401kInfo();
    }

    function renderBudgetSection() {
      const budgetTableBody = document.getElementById("budgetTableBody");
      const budgetTotalEl = document.getElementById("budgetTotal");
      const budgetTotalFrozenEl = document.getElementById("budgetTotalFrozen");
      if (!budgetTableBody || !budgetTotalEl) return;

      function calcBudgetTotalFromData() {
        let total = 0;
        personalBudgetRows.forEach(row => {
          const amt = row.amount || 0;
          if (!isNaN(amt)) total += amt;
        });
        budgetTotalEl.textContent = formatCurrency(total);
        if (budgetTotalFrozenEl) {
          budgetTotalFrozenEl.textContent = formatCurrency(total);
        }
        globalMonthlyExpensesTotal = total;
        updateBudgetPctOfIncome();
      }

      function renderBudgetTable() {
        if (!budgetEditMode) {
          budgetTableBody.innerHTML = personalBudgetRows.map(row => `
            <tr>
              <td>${escapeHtml(row.category)}</td>
              <td>${row.amount != null ? formatCurrency(row.amount) : ""}</td>
              <td>${escapeHtml(row.withdraw || "")}</td>
              <td>${escapeHtml(row.type || "")}</td>
              <td>${escapeHtml(row.notes || "")}</td>
            </tr>
          `).join("");
        } else {
          budgetTableBody.innerHTML = personalBudgetRows.map((row, idx) => `
            <tr>
              <td>
                <input
                  type="text"
                  class="budget-input budget-category"
                  data-index="${idx}"
                  value="${escapeHtml(row.category)}"
                />
              </td>
              <td>
                <input
                  type="text"
                  class="budget-input budget-amount"
                  data-index="${idx}"
                  value="${row.amount != null ? formatNumberWithCommas(row.amount.toString()) : ""}"
                />
              </td>
              <td>
                <input
                  type="text"
                  class="budget-input budget-withdraw"
                  data-index="${idx}"
                  value="${escapeHtml(row.withdraw || "")}" />
              </td>
              <td>
                <input
                  type="text"
                  class="budget-input budget-type"
                  data-index="${idx}"
                  value="${escapeHtml(row.type || "")}" />
              </td>
              <td>
                <input
                  type="text"
                  class="budget-input budget-notes"
                  data-index="${idx}"
                  value="${escapeHtml(row.notes || "")}" />
              </td>
            </tr>
          `).join("");

          document.querySelectorAll(".budget-category").forEach(input => {
            input.addEventListener("blur", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              personalBudgetRows[idx].category = e.target.value;
            });
          });

          document.querySelectorAll(".budget-amount").forEach(input => {
            input.addEventListener("input", (e) => {
              e.target.value = formatNumberWithCommas(e.target.value);
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              const val = getNumericValue(e.target.value);
              personalBudgetRows[idx].amount = isNaN(val) ? null : val;
              calcBudgetTotalFromData();
            });
            input.addEventListener("blur", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              const val = getNumericValue(e.target.value);
              personalBudgetRows[idx].amount = isNaN(val) ? null : val;
              calcBudgetTotalFromData();
            });
          });

          document.querySelectorAll(".budget-withdraw").forEach(input => {
            input.addEventListener("blur", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              personalBudgetRows[idx].withdraw = e.target.value;
            });
          });

          document.querySelectorAll(".budget-type").forEach(input => {
            input.addEventListener("blur", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              personalBudgetRows[idx].type = e.target.value;
            });
          });

          document.querySelectorAll(".budget-notes").forEach(input => {
            input.addEventListener("blur", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              personalBudgetRows[idx].notes = e.target.value;
            });
          });
        }

        calcBudgetTotalFromData();
      }

      renderBudgetTable();

      const budgetEditBtn = document.getElementById("budgetEditBtn");
      if (budgetEditBtn) {
        budgetEditBtn.textContent = budgetEditMode ? "Done" : "Edit budget";
        budgetEditBtn.onclick = async () => {
          if (budgetEditMode) {
            await savePersonalFinanceData({ budgetRows: personalBudgetRows });
          }
          budgetEditMode = !budgetEditMode;
          budgetEditBtn.textContent = budgetEditMode ? "Done" : "Edit budget";
          renderBudgetTable();
        };
      }

      if (!budgetSortHandlersAttached) {
        const sortAmountBtn = document.getElementById("budgetSortAmount");
        const sortCategoryBtn = document.getElementById("budgetSortCategory");

        if (sortAmountBtn) {
          sortAmountBtn.addEventListener("click", () => {
            budgetSortAmountAsc = !budgetSortAmountAsc;
            personalBudgetRows.sort((a, b) => {
              const va = a.amount || 0;
              const vb = b.amount || 0;
              return budgetSortAmountAsc ? vb - va : va - vb;
            });
            renderBudgetTable();
          });
        }

        if (sortCategoryBtn) {
          sortCategoryBtn.addEventListener("click", () => {
            budgetSortCategoryAsc = !budgetSortCategoryAsc;
            personalBudgetRows.sort((a, b) => {
              const ca = (a.category || "").toLowerCase();
              const cb = (b.category || "").toLowerCase();
              if (ca < cb) return budgetSortCategoryAsc ? -1 : 1;
              if (ca > cb) return budgetSortCategoryAsc ? 1 : -1;
              return 0;
            });
            renderBudgetTable();
          });
        }

        budgetSortHandlersAttached = true;
      }
    }

    function renderStoreSection() {
      const storeTableHead = document.getElementById("storeTableHead");
      const storeTableBody = document.getElementById("storeTableBody");
      const storeTotalCol1 = document.getElementById("storeTotalCol1");
      const storeTotalCol2 = document.getElementById("storeTotalCol2");
      const storeTotalCol3 = document.getElementById("storeTotalCol3");
      const editBtn = document.getElementById("storeEditBtn");
      const addBtn = document.getElementById("storeAddRowBtn");
      if (!storeTableHead || !storeTableBody) return;

      if (editBtn) {
        editBtn.textContent = storeEditMode ? "Done" : "Edit";
        editBtn.onclick = () => {
          storeEditMode = !storeEditMode;
          renderStoreSection();
        };
      }

      if (addBtn) {
        addBtn.classList.toggle("hidden", !storeEditMode);
        addBtn.onclick = () => {
          storeSpendingRows.push({ store: "", col1: null, col2: null, col3: null });
          renderStoreSection();
        };
      }

      storeTableHead.innerHTML = `
        <tr>
          <th>Category</th>
          ${storePeriodHeaders.map((h, idx) => `<th>${storeEditMode ? `<input type="text" class="store-header" data-index="${idx}" value="${escapeHtml(h)}" />` : escapeHtml(h)}</th>`).join("")}
        </tr>
      `;

      storeTableBody.innerHTML = storeSpendingRows.map((row, idx) => storeEditMode ? `
        <tr>
          <td><input type="text" class="store-name" data-index="${idx}" value="${escapeHtml(row.store)}" /></td>
          <td><input type="text" class="store-amount" data-row="${idx}" data-col="1" value="${row.col1 != null ? formatNumberWithCommas(row.col1.toString()) : ""}" /></td>
          <td><input type="text" class="store-amount" data-row="${idx}" data-col="2" value="${row.col2 != null ? formatNumberWithCommas(row.col2.toString()) : ""}" /></td>
          <td><input type="text" class="store-amount" data-row="${idx}" data-col="3" value="${row.col3 != null ? formatNumberWithCommas(row.col3.toString()) : ""}" /></td>
        </tr>
      ` : `
        <tr>
          <td>${escapeHtml(row.store)}</td>
          <td>${row.col1 != null ? formatCurrency(row.col1) : ""}</td>
          <td>${row.col2 != null ? formatCurrency(row.col2) : ""}</td>
          <td>${row.col3 != null ? formatCurrency(row.col3) : ""}</td>
        </tr>
      `).join("");

      function recalcStoreTotals() {
        let t1 = 0, t2 = 0, t3 = 0;
        storeSpendingRows.forEach(row => {
          t1 += row.col1 || 0;
          t2 += row.col2 || 0;
          t3 += row.col3 || 0;
        });
        if (storeTotalCol1) storeTotalCol1.textContent = formatCurrency(t1);
        if (storeTotalCol2) storeTotalCol2.textContent = formatCurrency(t2);
        if (storeTotalCol3) storeTotalCol3.textContent = formatCurrency(t3);
      }

      if (storeEditMode) {
        document.querySelectorAll(".store-header").forEach(input => {
          input.addEventListener("input", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            storePeriodHeaders[idx] = e.target.value;
          });
        });

        document.querySelectorAll(".store-name").forEach(input => {
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            storeSpendingRows[idx].store = e.target.value;
          });
        });

        document.querySelectorAll(".store-amount").forEach(input => {
          input.addEventListener("input", (e) => {
            e.target.value = formatNumberWithCommas(e.target.value);
            const rowIdx = parseInt(e.target.getAttribute("data-row"), 10);
            const col = e.target.getAttribute("data-col");
            const val = getNumericValue(e.target.value);
            storeSpendingRows[rowIdx][`col${col}`] = isNaN(val) ? null : val;
            recalcStoreTotals();
          });
          input.addEventListener("blur", (e) => {
            const rowIdx = parseInt(e.target.getAttribute("data-row"), 10);
            const col = e.target.getAttribute("data-col");
            const val = getNumericValue(e.target.value);
            storeSpendingRows[rowIdx][`col${col}`] = isNaN(val) ? null : val;
            recalcStoreTotals();
          });
        });
      }

      recalcStoreTotals();
    }

    function renderUpcomingSection() {
      const upcomingTableBody = document.getElementById("upcomingTableBody");
      const upcomingTotalEl = document.getElementById("upcomingTotal");
      const editBtn = document.getElementById("upcomingEditBtn");
      const addBtn = document.getElementById("upcomingAddRowBtn");
      if (!upcomingTableBody || !upcomingTotalEl) return;

      if (editBtn) {
        editBtn.textContent = upcomingEditMode ? "Done" : "Edit";
        editBtn.onclick = () => {
          upcomingEditMode = !upcomingEditMode;
          renderUpcomingSection();
        };
      }

      if (addBtn) {
        addBtn.classList.toggle("hidden", !upcomingEditMode);
        addBtn.onclick = () => {
          upcomingRows.push({ category: "", amount: null });
          renderUpcomingSection();
        };
      }

      upcomingTableBody.innerHTML = upcomingRows.map((row, idx) => upcomingEditMode ? `
        <tr>
          <td><input type="text" class="upcoming-category" data-index="${idx}" value="${escapeHtml(row.category)}" /></td>
          <td><input type="text" class="upcoming-amount" data-index="${idx}" value="${row.amount != null ? formatNumberWithCommas(row.amount.toString()) : ""}" /></td>
        </tr>
      ` : `
        <tr>
          <td>${escapeHtml(row.category)}</td>
          <td>${row.amount != null ? formatCurrency(row.amount) : ""}</td>
        </tr>
      `).join("");

      function recalcUpcomingTotal() {
        let total = 0;
        upcomingRows.forEach(row => {
          const val = row.amount || 0;
          if (!isNaN(val)) total += val;
        });
        upcomingTotalEl.textContent = formatCurrency(total);
      }

      if (upcomingEditMode) {
        document.querySelectorAll(".upcoming-category").forEach(input => {
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            upcomingRows[idx].category = e.target.value;
          });
        });

        document.querySelectorAll(".upcoming-amount").forEach(input => {
          input.addEventListener("input", (e) => {
            e.target.value = formatNumberWithCommas(e.target.value);
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            upcomingRows[idx].amount = isNaN(val) ? null : val;
            recalcUpcomingTotal();
          });
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            upcomingRows[idx].amount = isNaN(val) ? null : val;
            recalcUpcomingTotal();
          });
        });
      }

      recalcUpcomingTotal();
    }

    function renderDebtSection() {
      const debtTableBody = document.getElementById("debtTableBody");
      const debtTotalEl = document.getElementById("debtTotal");
      const editBtn = document.getElementById("debtEditBtn");
      const addBtn = document.getElementById("debtAddRowBtn");
      if (!debtTableBody || !debtTotalEl) return;

      if (editBtn) {
        editBtn.textContent = debtEditMode ? "Done" : "Edit";
        editBtn.onclick = () => {
          debtEditMode = !debtEditMode;
          renderDebtSection();
          renderGoals();
        };
      }

      if (addBtn) {
        addBtn.classList.toggle("hidden", !debtEditMode);
        addBtn.onclick = () => {
          debtRows.push({ name: "", balance: null });
          renderDebtSection();
          renderGoals();
        };
      }

      debtTableBody.innerHTML = debtRows.map((row, idx) => debtEditMode ? `
        <tr>
          <td><input type="text" class="debt-name" data-index="${idx}" value="${escapeHtml(row.name)}" /></td>
          <td><input type="text" class="debt-amount" data-index="${idx}" value="${row.balance != null ? formatNumberWithCommas(row.balance.toString()) : ""}" /></td>
        </tr>
      ` : `
        <tr>
          <td>${escapeHtml(row.name)}</td>
          <td>${row.balance != null ? formatCurrency(row.balance) : ""}</td>
        </tr>
      `).join("");

      function recalcDebtTotal() {
        let total = 0;
        debtRows.forEach(row => {
          const val = row.balance || 0;
          if (!isNaN(val)) total += val;
        });
        debtTotalEl.textContent = formatCurrency(total);
        renderGoals();
      }

      if (debtEditMode) {
        document.querySelectorAll(".debt-name").forEach(input => {
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            debtRows[idx].name = e.target.value;
            renderGoals();
          });
        });

        document.querySelectorAll(".debt-amount").forEach(input => {
          input.addEventListener("input", (e) => {
            e.target.value = formatNumberWithCommas(e.target.value);
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            debtRows[idx].balance = isNaN(val) ? null : val;
            recalcDebtTotal();
          });
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            debtRows[idx].balance = isNaN(val) ? null : val;
            recalcDebtTotal();
          });
        });
      }

      recalcDebtTotal();
    }

    function renderInvestSection() {
      const investTableBody = document.getElementById("investTableBody");
      const investTotalEl = document.getElementById("investTotal");
      const editBtn = document.getElementById("investEditBtn");
      const addBtn = document.getElementById("investAddRowBtn");
      if (!investTableBody || !investTotalEl) return;

      if (editBtn) {
        editBtn.textContent = investEditMode ? "Done" : "Edit";
        editBtn.onclick = async () => {
          if (investEditMode) {
            await savePersonalFinanceData({ investmentRows });
          }
          investEditMode = !investEditMode;
          renderInvestSection();
        };
      }

      if (addBtn) {
        addBtn.classList.toggle("hidden", !investEditMode);
        addBtn.onclick = () => {
          investmentRows.push({ name: "", balance: null });
          renderInvestSection();
        };
      }

      investTableBody.innerHTML = investmentRows.map((row, idx) => investEditMode ? `
        <tr>
          <td><input type="text" class="invest-name" data-index="${idx}" value="${escapeHtml(row.name)}" /></td>
          <td><input type="text" class="invest-amount" data-index="${idx}" value="${row.balance != null ? formatNumberWithCommas(row.balance.toString()) : ""}" /></td>
        </tr>
      ` : `
        <tr>
          <td>${escapeHtml(row.name)}</td>
          <td>${row.balance != null ? formatCurrency(row.balance) : ""}</td>
        </tr>
      `).join("");

      function recalcInvestTotal() {
        let total = 0;
        investmentRows.forEach(row => {
          const val = row.balance || 0;
          if (!isNaN(val)) total += val;
        });
        investTotalEl.textContent = formatCurrency(total);
      }

      if (investEditMode) {
        document.querySelectorAll(".invest-name").forEach(input => {
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            investmentRows[idx].name = e.target.value;
          });
        });

        document.querySelectorAll(".invest-amount").forEach(input => {
          input.addEventListener("input", (e) => {
            e.target.value = formatNumberWithCommas(e.target.value);
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            investmentRows[idx].balance = isNaN(val) ? null : val;
            recalcInvestTotal();
          });
          input.addEventListener("blur", (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            const val = getNumericValue(e.target.value);
            investmentRows[idx].balance = isNaN(val) ? null : val;
            recalcInvestTotal();
          });
        });
      }

      recalcInvestTotal();
    }

    function renderPersonalFinance() {
      if (!document.getElementById("budgetTableBody")) return;
      updatePersonalIncomePills();
      attachPf401kListeners();
      renderBudgetSection();
      renderStoreSection();
      renderUpcomingSection();
      renderDebtSection();
      renderInvestSection();
      renderGoals();
    }

    function renderGoals() {
      const readingTarget = 55;
      const readingSummaryEl = document.getElementById("readingGoalSummary");
      const readingGoalProgressEl = document.getElementById("readingGoalProgress");
      const readingCardProgressEl = document.getElementById("readingCardProgress");
      const readingStatsEl = document.getElementById("readingGoalStats");
      const readingEditBtn = document.getElementById("readingEditBtn");
      const booksCompletedBody = document.getElementById("booksCompletedBody");
      const booksToReadBody = document.getElementById("booksToReadBody");
      const booksCompletedAddBtn = document.getElementById("booksCompletedAddBtn");
      const booksToReadAddBtn = document.getElementById("booksToReadAddBtn");
      const debtGoalSummaryEl = document.getElementById("debtGoalSummary");
      const debtGoalProgressEl = document.getElementById("debtGoalProgress");
      const debtGoalBody = document.getElementById("debtGoalBody");
      const debtGoalTotalEl = document.getElementById("debtGoalTotal");
      const debtNotesView = document.getElementById("debtNotesView");
      const debtNotesInput = document.getElementById("debtNotesInput");
      const debtGoalEditBtn = document.getElementById("debtGoalEditBtn");

      const setProgressWidth = (el, pct) => {
        if (el) {
          const clamped = Math.min(Math.max(pct, 0), 100);
          el.style.width = clamped + "%";
        }
      };

      const refreshReadingDisplays = () => {
        const completedCount = readingCompletedRows.filter(r => (r.title || "").trim()).length;
        const remaining = Math.max(readingTarget - completedCount, 0);
        const pct = readingTarget > 0 ? (completedCount / readingTarget) * 100 : 0;
        if (readingSummaryEl) {
          readingSummaryEl.textContent = `Completed: ${completedCount} / ${readingTarget}`;
        }
        setProgressWidth(readingGoalProgressEl, pct);
        setProgressWidth(readingCardProgressEl, pct);
        if (readingStatsEl) {
          readingStatsEl.textContent = `Target: ${readingTarget} · Completed: ${completedCount} · Remaining: ${remaining}`;
        }
      };

      refreshReadingDisplays();

      if (goalsSortReadingBtn) {
        goalsSortReadingBtn.textContent = readingSortAsc ? "Sort reading A/Z" : "Sort reading Z/A";
        goalsSortReadingBtn.onclick = () => {
          const comparator = (a, b) => {
            const titleA = (a.title || "").toLowerCase();
            const titleB = (b.title || "").toLowerCase();
            if (!titleA && !titleB) return 0;
            if (!titleA) return 1;
            if (!titleB) return -1;
            return readingSortAsc ? titleA.localeCompare(titleB) : titleB.localeCompare(titleA);
          };
          readingCompletedRows.sort(comparator);
          readingToReadRows.sort(comparator);
          readingSortAsc = !readingSortAsc;
          renderGoals();
        };
      }

      if (goalsSortDebtBtn) {
        goalsSortDebtBtn.textContent = debtSortDesc ? "Sort debt high/low" : "Sort debt low/high";
        goalsSortDebtBtn.onclick = () => {
          debtRows.sort((a, b) => {
            const aVal = a.balance || 0;
            const bVal = b.balance || 0;
            return debtSortDesc ? bVal - aVal : aVal - bVal;
          });
          debtSortDesc = !debtSortDesc;
          renderGoals();
        };
      }

      if (readingEditBtn) {
        readingEditBtn.textContent = readingEditMode ? "Done" : "Edit Reading List";
        readingEditBtn.onclick = async () => {
          if (readingEditMode) {
            await savePersonalFinanceData({
              readingCompletedRows,
              readingToReadRows
            });
          }
          readingEditMode = !readingEditMode;
          renderGoals();
        };
      }

      if (booksCompletedAddBtn) {
        booksCompletedAddBtn.classList.toggle("hidden", !readingEditMode);
        booksCompletedAddBtn.onclick = () => {
          readingCompletedRows.push({ title: "", author: "", format: "", rating: "", monthFinished: "", notes: "" });
          renderGoals();
        };
      }

      if (booksToReadAddBtn) {
        booksToReadAddBtn.classList.toggle("hidden", !readingEditMode);
        booksToReadAddBtn.onclick = () => {
          readingToReadRows.push({ title: "", author: "" });
          renderGoals();
        };
      }

      if (booksCompletedBody) {
        booksCompletedBody.innerHTML = readingCompletedRows.map((row, idx) => readingEditMode ? `
          <tr>
            <td><input type="text" class="completed-title" data-index="${idx}" value="${escapeHtml(row.title)}" /></td>
            <td><input type="text" class="completed-author" data-index="${idx}" value="${escapeHtml(row.author)}" /></td>
            <td><input type="text" class="completed-format" data-index="${idx}" value="${escapeHtml(row.format)}" /></td>
            <td><input type="text" class="completed-rating" data-index="${idx}" value="${escapeHtml(row.rating)}" /></td>
            <td><input type="text" class="completed-month" data-index="${idx}" value="${escapeHtml(row.monthFinished || "")}" /></td>
            <td><input type="text" class="completed-notes" data-index="${idx}" value="${escapeHtml(row.notes)}" /></td>
          </tr>
        ` : `
          <tr>
            <td>${escapeHtml(row.title)}</td>
            <td>${escapeHtml(row.author)}</td>
            <td>${escapeHtml(row.format)}</td>
            <td>${escapeHtml(row.rating)}</td>
            <td>${escapeHtml(row.monthFinished || "")}</td>
            <td>${escapeHtml(row.notes)}</td>
          </tr>
        `).join("");

        if (readingEditMode) {
          const bindInput = (selector, key) => {
            document.querySelectorAll(selector).forEach(input => {
              input.addEventListener("input", (e) => {
                const idx = parseInt(e.target.getAttribute("data-index"), 10);
                readingCompletedRows[idx][key] = e.target.value;
                refreshReadingDisplays();
              });
              input.addEventListener("blur", refreshReadingDisplays);
            });
          };
          bindInput(".completed-title", "title");
          bindInput(".completed-author", "author");
          bindInput(".completed-format", "format");
          bindInput(".completed-rating", "rating");
          bindInput(".completed-month", "monthFinished");
          bindInput(".completed-notes", "notes");
        }
      }

      if (booksToReadBody) {
        booksToReadBody.innerHTML = readingToReadRows.map((row, idx) => readingEditMode ? `
          <tr>
            <td><input type="text" class="toread-title" data-index="${idx}" value="${escapeHtml(row.title)}" /></td>
            <td><input type="text" class="toread-author" data-index="${idx}" value="${escapeHtml(row.author)}" /></td>
          </tr>
        ` : `
          <tr>
            <td>${escapeHtml(row.title)}</td>
            <td>${escapeHtml(row.author)}</td>
          </tr>
        `).join("");

        if (readingEditMode) {
          document.querySelectorAll(".toread-title").forEach(input => {
            input.addEventListener("input", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              readingToReadRows[idx].title = e.target.value;
            });
          });
          document.querySelectorAll(".toread-author").forEach(input => {
            input.addEventListener("input", (e) => {
              const idx = parseInt(e.target.getAttribute("data-index"), 10);
              readingToReadRows[idx].author = e.target.value;
            });
          });
        }
      }

      const debtTotal = debtRows.reduce((sum, row) => sum + (row.balance || 0), 0);
      if (debtGoalSummaryEl) {
        debtGoalSummaryEl.textContent = "Total debt: " + formatCurrency(debtTotal);
      }
      if (debtGoalBody) {
        debtGoalBody.innerHTML = debtRows.map(row => `
          <tr>
            <td>${escapeHtml(row.name)}</td>
            <td>${row.balance != null ? formatCurrency(row.balance) : ""}</td>
          </tr>
        `).join("");
      }
      if (debtGoalTotalEl) {
        debtGoalTotalEl.textContent = formatCurrency(debtTotal);
      }
      setProgressWidth(debtGoalProgressEl, debtTotal > 0 ? 100 : 0);

      if (debtNotesView && debtNotesInput) {
        debtNotesView.textContent = debtStrategyNotes || "No notes yet.";
        debtNotesInput.value = debtStrategyNotes || "";
        debtNotesView.classList.toggle("hidden", debtGoalEditMode);
        debtNotesInput.classList.toggle("hidden", !debtGoalEditMode);
      }

      if (debtGoalEditBtn) {
        debtGoalEditBtn.textContent = debtGoalEditMode ? "Done" : "Edit";
        debtGoalEditBtn.onclick = async () => {
          if (debtGoalEditMode && debtNotesInput) {
            debtStrategyNotes = debtNotesInput.value;
            await savePersonalFinanceData({ debtNotes: debtStrategyNotes });
          }
          debtGoalEditMode = !debtGoalEditMode;
          renderGoals();
        };
      }
    }

    async function onSaveDashboardClick() {
      const user = auth.currentUser;
      if (!user) {
        alert("Please sign in to save your dashboard.");
        return;
      }

      try {
        await savePersonalFinanceDataForUser(user.uid);
        await saveCommissionTrackerDataForUser(user.uid);
        await saveGoalsDataForUser(user.uid);

        console.log("Dashboard saved");
      } catch (err) {
        console.error("Error saving dashboard", err);
        alert("There was a problem saving your data. Please try again.");
      }
    }

    // --- Tabs logic ---
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (tab === "commission") {
          commissionTab.classList.remove("hidden");
          personalTab.classList.add("hidden");
          goalsTab.classList.add("hidden");
        } else if (tab === "personal") {
          commissionTab.classList.add("hidden");
          personalTab.classList.remove("hidden");
          goalsTab.classList.add("hidden");
        } else {
          commissionTab.classList.add("hidden");
          personalTab.classList.add("hidden");
          goalsTab.classList.remove("hidden");
          renderGoals();
        }
      });
    });

    // --- Auth (Google) ---
    signInBtn.addEventListener("click", async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (err) {
        console.error("Sign-in error", err);
        alert("Error signing in: " + (err.message || err));
      }
    });

    signOutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
      } catch (err) {
        console.error("Sign-out error", err);
        alert("Error signing out: " + (err.message || err));
      }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (user) {
        authStatus.textContent = "Signed in as " + user.email;
        signInBtn.classList.add("hidden");
        signOutBtn.classList.remove("hidden");
        appContent.classList.remove("hidden");
        populateTerms();
        await renderHistory();
        await loadCompTracker();
        await loadPersonalFinanceData();
        await loadGoalsDataForUser(user.uid);
        renderPersonalFinance();
      } else {
        authStatus.textContent = "Not signed in.";
        signInBtn.classList.remove("hidden");
        signOutBtn.classList.add("hidden");
        appContent.classList.add("hidden");
        resetPersonalFinanceState();
        historyBody.innerHTML = "";
        totalsAmountEl.textContent = "$0";
        totalsPostTaxEl.textContent = "$0";
        totalsFirstMonthEl.textContent = "$0";
        kpiThisMonth.textContent = "$0";
        kpiFiscalYtd.textContent = "$0";
        kpiLargestDeal.textContent = "$0";
        kpiFiscalYtdFirst.textContent = "$0";
        compSummaryEl.textContent = "Sign in to view your compensation tracker.";
        if (compPieChart) {
          compPieChart.destroy();
          compPieChart = null;
        }
        if (compLineChart) {
          compLineChart.destroy();
          compLineChart = null;
        }
        renderGoals();
      }
    });

    // Initialize term dropdown on first load
    populateTerms();
  </script>
</body>
</html>
